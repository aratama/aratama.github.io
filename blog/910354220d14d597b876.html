<!DOCTYPE html>
<meta charset="UTF-8">

<!-- Twitter card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@cubbit2">
<meta name="twitter:creator" content="@cubbit2">
<meta name="twitter:title" content="モナドのまほう　第14話『冒涜的Firebase活用法』 - ちょっと小さいのはたしかですが。">
<meta name="twitter:description" content="Admittedly something small.">
<meta name="twitter:image" content="https://aratama.github.io/img/e9b2a088-ae7a-244e-a51b-84861b2125c4.png">

<link rel="icon" type="image/png" href="icon.png">
<link rel="stylesheet" href="/res/reset.css">
<link rel="stylesheet" href="/res/style.css">

<title>モナドのまほう　第14話『冒涜的Firebase活用法』 - ちょっと小さいのはたしかですが。</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61162129-3', 'auto');
  ga('send', 'pageview');

</script>

<header>
    <div class="block-centered">
        <div class="site-title"><a href="/">ちょっと小さいのはたしかですが。</a></div>
        <div class="sub-title">Admittedly something small.</div>
    </div>
</header>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<!--
<link rel="stylesheet" href="/lib/highlight/styles/default.css">
<script src="/lib/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
-->

<!--
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$']]}
});
</script>
-->


<link rel="stylesheet" href="/res/article.css">


    <div class="content">

        <article id="rendered">
            <div class="date">2016年12月27日</div>
            <h1 class="article-title">
                <!-- <i class="fa fa-coffee" aria-hidden="true"></i> -->
                <a href="910354220d14d597b876.html">モナドのまほう　第14話『冒涜的Firebase活用法』<a>
            </h1>        
            <p class="tags"><a href="JavaScript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>JavaScript</span></a>
<a href="purescript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>purescript</span></a>
<a href="Firebase.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>Firebase</span></a></p>
            <hr>
            <p><a href="/blog/5321d8cebce7b87851f6.html">第一話</a> / <a href="/blog/c9701d80db46b7850f58.html">前回</a></p><p>淡々とゲームを作る日記です。ステラのまほう２期を待ち望んでいます。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>ワールドの地形データを保存するようにしました</h1><p>そろそろゲームのプレイデータの永続化をどうするか考えなきゃと思って、ワールドのデータの保存を仮実装しました。シングルプレイはIndexedDBに、マルチプレイではFirebaseにデータを保存します。これで、ブロックを置いたりしたあとで再びゲームを読み込むと、以前の状態が再現されてゲームを再開できます。また、マルチプレイヤーモードを複数のウィンドウで開くと、一方でブロックを置いた時に他方でちゃんと反映されるのが確認できました。オンラインゲームだコレ！</p><p><a href="/img/e9b2a088-ae7a-244e-a51b-84861b2125c4.png"><img src="/img/e9b2a088-ae7a-244e-a51b-84861b2125c4.png"></img></a></p><p>画像は、私がなぜかゲーム内でときどき建立している鳥居です。他のプレイヤーキャラクターの様子はまだ見れませんので、突然にょきっと地形が変わる感じになっちゃってます。そろそろマルチプレイ用のキャラクターを用意したいです。Firebaseはほんとにシンプルで楽ちんです。</p><h1><a name="firebase-" class="anchor" href="#firebase-"><span class="header-link"></span></a>Firebaseに配列を保存するときに容量をケチるたったひとつの冴えたやりかた</h1><p>Firebaseは任意のJSONデータを格納できるものの、配列とはあまり相性がよくありません。詳細は<a href="https://firebase.googleblog.com/2014/04/best-practices-arrays-in-firebase.html">こちら</a>を読むといいと思いますが、要するに配列の要素を挿入したり削除したりすると要素の位置がズレるので、データの対応をとるのが面倒くさいというわけです。それで配列を格納しようとしても内部的には結局オブジェクトのテーブルとして保存されており、配列としての一定の条件が揃った時だけ配列として取り出される、という振る舞いになっています。容量の効率としてはぜんぜん良くないのです。</p><p>ところが、本作ではワールドの地形データを<code>Uint8Array</code>で保持しており、それをRealtime Databaseに保存するにあたってデータ転送量をどうケチるか考えていたんですが、いい方法が思いつきました。手順としては、チャンクは長さ<code>16 * 16 * 16 = 4096</code>の<code>Uint8Array</code>で表現されているのですが、これを<code>fromCharCode</code>でもう単純に文字列に置き換えます。そしてこれを<a href="http://pieroxy.net/blog/pages/lz-string/index.html">lz-string</a>で文字列として圧縮するんです。普通は文字列データを圧縮してバイナリの圧縮ファイルになるものですが、<code>Uint8Array</code>のバイナリデータを文字列にして圧縮するという斜め上の発想。なぜfirebaseを使っているのかちょっとわからなくなってきました。</p><pre><code class="js">var compressed = LZString.compressToUTF16(String.fromCharCode.apply(null, uint8array))

var decompressed = new Uint8Array(LZString.decompressFromUTF16(compressed).split(&quot;&quot;).map(c =&gt; c.charCodeAt(0)));</code></pre><p>JavaScriptの文字列はUTF-16で表現されているので文字列化すると<code>8192</code>バイトほどになる計算ですが、現状の地形生成では同じ種類のデータが連続することが多く、これを圧縮すると130文字≒260バイトにまで小さくなり転送量を大幅に削減できます。firebaseはオブジェクトの一部を変更するとその差分だけ転送してくれるようなのですが、転送量を削減しようと下手にその振る舞いを利用しようとしたのがよくありませんでした。今回の方法だと１ブロック単位の差分は使えずにチャンクをまるごと転送することになりますが、最初にチャンクを読み込んだ時の転送量を考えると、生のオブジェクトを転送するよりも軽くなるのです。なぜ今までこれに気付かなかったのかという感じですが、Firebaseには生のJSONデータを格納するものだという思い込みがありました。今回は文字列にしてから圧縮しましたが、ZIPか何かでバイナリとして圧縮してからbase64にエンコードしてもいいかもしれません。そもそもバイナリデータをRealtime Databaseに保存しようということ自体がかなりのレアケースなんですけども。</p><p>ここまで軽くなるなら、ワールド全体を<code>on</code>で読み続けても大丈夫そうな気もします。1000チャンクが編集済みでも全体は300kbytes程度。超根性のあるプレイヤーでも1000チャンクを編集するのは並大抵ではないでしょう。もちろんブロックの配置のエントロピーが大きくなるにつれて圧縮率は低下しますが、複雑なチャンクを圧縮して１０倍の3000バイトになったとしても3メガバイト程度。もしユーザが何万人も押し寄せたら考え直しますが、さすがにそこまでの心配はいらないでしょう。というかそんな事態になったらそもそもfirebaseじゃなくて専用のサーバが必要でしょうし。</p><p>初回に距離10チャンクまでのチャンクを読み込むとして、ワールド全体で<code>21 * 21 * 21 * 300bytes ≒ 2.7MBytes</code>くらい。実際には空中や地中では同じ種類のブロックが連続するのでもっと圧縮できるはずで、もしかしたら1MByte以下かもしれません。それ以降、ひとつブロックを置くごとに300バイトほどのデータが転送されるとして、1秒に一個づつブロックを置き続けるのを１時間続けたとして、<code>300bytes * 60 * 60 ≒ 1MB</code>ほど。これなら相当の回数プレイしても、そうそう無料枠の転送量10GB/月を使い切ることはないでしょう！リアルタイムデータベースよりもむしろホスティングのほうがアレです。ファイル全体で17MBytesもあるので、あんまりたくさんのアクセスを受けたら使いきってしまうでしょう。それこそニコニコのRPGアツマールにでもホストさせておくのがいいかもしれません。</p><p>lz-stringで圧縮した文字列をFirebaseに保存するときのコツとして、<code>compressToUTF16</code>/<code>decompressFromUTF16</code>をつかうといいようです。<code>compress</code>/<code>decompress</code>だとFirebaseに持ってきた時に一部の文字がエスケープされてしまいちゃんと復元できません。firebaseらしくない使い方ですし、こんなTipsに需要はないと思いますが……。</p><h1><a name="purescript-dom-" class="anchor" href="#purescript-dom-"><span class="header-link"></span></a>purescript-domの頭がどうかしている件</h1><p>ページを開いときにフォーカスがアドレスバーにあたっていることもあります。今はタイトルページで一度画面をクリックするという仕様になっているのでフォーカスを自動的に移す必要はないのですが、以前はいきなりプレイ画面だったので、ページを再読み込みしてから前に歩こうとwキーを押してアドレスバーにwwwwwwwwwwwwwwwwwwって入力されてしまうという事故が何度も起きてました。それでページのレンダリングが完了した時点でイベントリスナを仕掛けている要素にフォーカスを当てるという処理が欲しくなったんですが、でもこれは<code>purescript-halogen</code>の仮想DOMだけではできないので、<code>purescript-dom</code>で生DOMを触ることにしました。JavaScriptでやると次のようなコードです。</p><pre><code class="js">document.getElementById(&quot;content&quot;).focus();</code></pre><p>これがです。<a href="https://github.com/purescript-contrib/purescript-dom"><code>purescript-dom</code></a>で書くとこうなります。</p><pre><code class="haskell">(window &gt;&gt;= document &lt;#&gt; htmlDocumentToNonElementParentNode &gt;&gt;= getElementById (ElementId &quot;content&quot;) &lt;#&gt; toMaybe) &gt;&gt;= traverse_ (focus &lt;&lt;&lt; unsafeCoerce)</code></pre><p>なんじゃこりゃあ！　こんなのパッと書けるわけないだろいいかげんにしろ！　しかも結局<code>unsafeCoerce</code>で無理やり型変換する必要があって、型安全性が台無しです。これだけいろんなデータ型がごちゃまぜにつめ込まれたDOMツリーからクエリで要素を選択し取り出すという考えかた自体がそもそも無理ゲーで、そういう雑なAPIはPureScriptには向かないのです。PureScriptで生DOM触るのはほんとに苦労しかないので、なるべく避けましょう……。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>充　実　し　た　オ　プ　シ　ョ　ン</h1><p>シングルプレイヤーモードとマルチプレイヤーモードの二種類のゲームモードができたので、モード選択画面を仮実装しました。</p><p><a href="/img/8376e4b4-e788-c9c0-2438-4ccf863a7369.png"><img src="/img/8376e4b4-e788-c9c0-2438-4ccf863a7369.png"></img></a></p><p>もっと画面全体に動きを入れて賑やかにしたいですが、デザインはちょっと守備範囲外なのでなかなかアイデアが出てきません。それに、ゲーム全体を通してデザインに統一感がなくて、中核になるデザインコンセプトが欠けているって感じです。とはいえいろいろ実装すればするほど課題が見えてくるので、とにかく作業を進めて後で考えるのは悪くない気がします。</p><p>ゲームの設定画面のデザインもいろいろいじろうとしてますが、なかなかコンセプトが見えてきません。うーん。</p><p><a href="/img/ab7a7e08-1b2c-32d3-bb21-314889ab1452.png"><img src="/img/ab7a7e08-1b2c-32d3-bb21-314889ab1452.png"></img></a></p><p>いま借りている無料素材のBGMに<a href="http://dova-s.jp/bgm/play2142.html">中田ヤスタカさんっぽいテクノポップな曲</a>があって、その雰囲気が気に入りました。サウンドからグラフィックまで含めて、そういうポップ系でゲーム全体を統一してみたい感があります。ストリングスのピチカートとグロッケン？でメロディーをなぞりつつ、ベースやパーカッションはテクノでエレクトロな音源のやつを使って、なんかよくわからないピロピロしたエフェクトが入っていて。あとハンドクラップ？こういうのが自分で作れるといいんですけど。ちょっと私の技術が追いついていないです。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>次のお話</h1><ul>
<li><a href="/blog/6b4353009059836569d1.html">第15話</a></li>
</ul>

            
<hr style="margin-top: 60px;">

<div class="snsbuttons">

    <!-- Twitter -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-related="cubbit2">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <!-- Hatena -->
    <div>
        <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>

    <!-- line -->
    <div>
        <div class="line-it-button" style="display: none;" data-type="share-a" data-lang="ja" ></div>
        <script src="//scdn.line-apps.com/n/line_it/thirdparty/loader.min.js" async="async" defer="defer" ></script>
    </div>

    <!--facebook -->
    <div>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8";
        fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
        <div class="fb-like" data-href="https://aratama.github.io/blog/${metadata.id}.md" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false"></div>
    </div>

    <!-- google+ -->
    <div>
        <script src="https://apis.google.com/js/platform.js" async defer>
        {lang: 'ja'}
        </script>
        <div class="g-plusone" data-size="medium"></div>
    </div>

</div>
        </article>
    </div>

<footer>
    <div class="block-centered footer-inner">
        <p class="copy">&nbsp;</p>
        <p class="author">このブログを書いてる人:&nbsp;&nbsp; 竹内稲穂<p>
    </div>

    <script>
        const poem = [
            "なんにもない毎日が、なによりの宝物。",
            "今日という日を、何度でも繰り返したい。",
            "世界を追いかけなくても、世界は私のまわりにある。", 
            "速すぎる雑踏。鼻先をくすぐる春風。", 
            "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
            "落ち葉が地面に、触れる音がした。", 
            "明日は、明日の楽しさが待っている。", 
            "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
            "もうここには何もない。だから、次の場所に旅立とう。", 
            "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
            "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
            "思い出はいつだって輝いてる。",
            "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
            "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
            "夜明けを、探しにいこう。", 
            "空はこんなに青かったんだ。", 
            "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
            "休み時間は、長すぎるということはない。", 
            "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
            "ちょっと小さいのは確かですが、それは確かにここにあります。", 
            "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
            "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
        ];
    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
    </script>
</footer>

