<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@cubbit2"><meta name="twitter:creator" content="@cubbit2"><meta name="twitter:title" content="rollup-plugin-pursでPureScriptのモジュールを結合する(インライン化、デッドコード排除) - ちょっと小さいのはたしかですが。"><meta name="twitter:description" content="rollup-plugin-pursでPureScriptのモジュールを結合する(インライン化、デッドコード排除)"><meta name="twitter:image" content="https://aratama.github.io/blog/d01e99df25c82f463b61/thumbnail.jpg"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="icon.png"><link rel="stylesheet" href="/res/reset.css"><link rel="stylesheet" href="/res/style.css"><title>rollup-plugin-pursでPureScriptのモジュールを結合する(インライン化、デッドコード排除) - ちょっと小さいのはたしかですが。</title><script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-61162129-3', 'auto');
                ga('send', 'pageview');
            </script></head><body><header><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61"><img src="/res/twitter.png" alt="twitter button"></a><a target="brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61&amp;t=undefined"><img src="/res/facebook.png" alt="facebook button"></a><a target="brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61"><img src="/res/google.png" alt="google plus button"></a><a target="brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61"><img src="/res/hatena.png" alt="hatena bookmark button"></a><a target="brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61&amp;title=undefined"><img src="/res/pocket.png" alt="pocket button"></a></div><div class="block-centered"><div class="site-title"><a href="/">Admittedly <wbr>something <wbr>small.</a></div><div class="sub-title">ちょっと<wbr>小さいのは<wbr>たしかですが。</div></div></header><div class="content"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/res/article.css"><article id="rendered"><div class="date">2017年2月5日</div><h1 class="article-title"><a href=".">rollup-plugin-pursでPureScriptのモジュールを結合する(インライン化、デッドコード排除)</a></h1><p class="tags"><a href="/blog/tag/purescript"><span class="tag"><i class="fa fa-tag"></i>purescript</span></a><a href="/blog/tag/rollup.js"><span class="tag"><i class="fa fa-tag"></i>rollup.js</span></a></p><hr><div><p>現状のPureScriptでは、コンパイル後のモジュールを結合するのに</p>
<ul>
<li>browserifyやwebpackを使って通常のCommonjsモジュールとして結合する方法（でかい）</li>
<li>psc-bundleを使って結合する方法（デッドコード削除が効くので、こっちのほうが断然結合後のファイルサイズが小さい。ただしかなり遅いし、PureScriptから出力されたCommonjsモジュールしか結合できないので、それ以外のCommonJSモジュールを結合するにはさらにwebpackなどをキメる必要がある）</li>
</ul>
<p>の2種類があります。ここで、新たに<a href="https://github.com/rollup/rollup">rollup</a>のプラグイン<a href="https://github.com/Pauan/rollup-plugin-purs">rollup-plugin-purs</a>を使う方法が加わったようです。特徴としては、</p>
<ul>
<li>psc-bundleと同様のデッドコード排除が効きます</li>
<li>さらにインライン化もある程度効くようで、結合後のファイルサイズのさらなる削減とともに、実行効率の向上も期待できます</li>
</ul>
<p>となんだかとても良さげです。使い方はrollupをインストールして、</p>
<pre><code>$ npm install -g rollup
</code></pre>
<p>rollup-plugin-pursをインストールして、</p>
<pre><code>$ npm install --save-dev rollup-plugin-purs
</code></pre>
<p>なんかこんな感じに<code>rollup.config.js</code>を書いて、</p>
<pre><code class="language-js:rollup.config.js">import purs from &quot;rollup-plugin-purs&quot;;

export default {
  entry: &quot;src/Main.purs&quot;,
  dest: &quot;bundle.js&quot;,
  format: &quot;iife&quot;,
  sourceMap: true,
  plugins: [
    purs()
  ]
};
</code></pre>
<p>rollupを実行するだけです。</p>
<pre><code>$ rollup --config
</code></pre>
<p>たとえば、</p>
<pre><code class="language-haskell:PureScript">sum x y = x + y

main = logShow (sum 20 22)
</code></pre>
<p>こんなかんじのコードをpsc-bundleで結合すると、</p>
<pre><code class="language-js:JavaScript">  var sum = function (dictSemiring) {
      return function (x) {
          return function (y) {
              return Data_Semiring.add(dictSemiring)(x)(y);
          };
      };
  };
  var main = Control_Monad_Eff_Console.logShow(Data_Show.showInt)(sum(Data_Semiring.semiringInt)(20)(22));
</code></pre>
<p>こんな感じのコードがそのまま結合されるのですが、rollup-plugin-pursで結合した場合は、</p>
<pre><code class="language-js:JavaScript">  var _main = _logShow_uncurried(_showInt, ((_semiringInt.add)(20)(22)));
</code></pre>
<p>だけが吐かれて、<code>sum</code>の呼び出しがインライン化されて消滅してるのが確認できました。また、<code>_logShow_uncurried</code>という関数が見えますが、これは関数<code>_logShow</code>のカリー化を解除したバージョンで、次のような関数がrollup-plugin-pursによって自動的に定義されます。</p>
<pre><code class="language-js:JavaScript">  var _logShow_uncurried = function (_dictShow, _a) {
    return _log2((_dictShow.show)(_a));
  };
</code></pre>
<p>そして、引数がすべて与えられた場合はカリー化が解除されたバージョンが使われるようになるようです。PureScriptは関数がデフォルトでカリー化されるので関数呼び出しが多くなり効率上のオーバーヘッドが大きいのですが、これで少しはオーバーヘッドが低減できそうです。ただし、私が試した範囲ではエラーが出て結合できないモジュールもありました。なんかシングルクォーテーションがついた名前の関数がお気に召さないようです。まだ実用的な完成度とまでは言えませんが、メリットが多いので今後に期待したいところです。</p>
<p>まだ議論の最中のようですが、pscも将来的にはES6モジュールを吐くようになるかもしれません。また、ブラウザ環境などでもES6 modulesが使えるようになれば、psc-bundleのようなツールで結合する必要自体がなくなるかもしれません。つーかES6 Modulesはやくしろよ！今どきモジュールがない言語なんてアホくさくて使ってられんわ！</p>
<h1>参考</h1>
<ul>
<li>https://github.com/Pauan/rollup-plugin-purs/issues/6 一部のコードでエラーが起こるのは、acornの既知の問題っぽいです。すでに修正されているので、rollupがバージョンアップされれば直るかも</li>
<li>https://github.com/purescript/purescript/issues/2574#issuecomment-277434874</li>
<li>https://github.com/Pauan/rollup-plugin-purs</li>
</ul>
</div></article></div><footer><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61"><img src="/res/twitter.png" alt="twitter button"></a><a target="brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61&amp;t=undefined"><img src="/res/facebook.png" alt="facebook button"></a><a target="brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61"><img src="/res/google.png" alt="google plus button"></a><a target="brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61"><img src="/res/hatena.png" alt="hatena bookmark button"></a><a target="brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fd01e99df25c82f463b61&amp;title=undefined"><img src="/res/pocket.png" alt="pocket button"></a></div><div class="block-centered footer-inner"><p class="copy">&amp;nbsp;</p><p class="author">このブログを書いてる人: 竹内稲穂</p></div><script>
                    const poem = [
                        "なんにもない毎日が、なによりの宝物。",
                        "今日という日を、何度でも繰り返したい。",
                        "世界を追いかけなくても、世界は私のまわりにある。", 
                        "速すぎる雑踏。鼻先をくすぐる春風。", 
                        "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
                        "落ち葉が地面に、触れる音がした。", 
                        "明日は、明日の楽しさが待っている。", 
                        "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
                        "もうここには何もない。だから、次の場所に旅立とう。", 
                        "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
                        "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
                        "思い出はいつだって輝いてる。",
                        "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
                        "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
                        "夜明けを、探しにいこう。", 
                        "空はこんなに青かったんだ。", 
                        "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
                        "休み時間は、長すぎるということはない。", 
                        "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
                        "ちょっと小さいのは確かですが、それは確かにここにあります。", 
                        "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
                        "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
                    ];
                    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
                </script></footer></body></html>