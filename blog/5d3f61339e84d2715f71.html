<title>モナドのまほう　第３話『オンラインゲームになりました』 - ちょっと小さいのはたしかですが。</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<link rel="stylesheet" href="/res/highlight/styles/default.css">
<script src="/res/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$']]}
});
</script>

<link rel="stylesheet" href="../reset.css">
<link rel="stylesheet" href="../style.css">

<body>
    <header><a href="index.html">ちょっと小さいのはたしかですが。</a></header>
    <div class="content">

        <article id="rendered">
            <div class="date">2016年10月32日</div>
            <h1 class="article-title">モナドのまほう　第３話『オンラインゲームになりました』</h1>        
            <p class="tags"><a href="JavaScript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>JavaScript</span></a>
<a href="purescript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>purescript</span></a>
<a href="オンラインゲーム.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>オンラインゲーム</span></a>
<a href="Firebase.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>Firebase</span></a>
<a href="関数型プログラミング.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>関数型プログラミング</span></a></p>
            <hr>
            <!-- {
  "id": "5d3f61339e84d2715f71",
  "created_at": "2016-10-31T06:56:43+09:00",
  "tags": [
    {
      "name": "JavaScript",
      "versions": []
    },
    {
      "name": "purescript",
      "versions": []
    },
    {
      "name": "オンラインゲーム",
      "versions": []
    },
    {
      "name": "Firebase",
      "versions": []
    },
    {
      "name": "関数型プログラミング",
      "versions": []
    }
  ],
  "title": "モナドのまほう　第３話『オンラインゲームになりました』"
} -->
<ul>
<li><a href="http://qiita.com/hiruberuto/items/5a2b613378d07906c5c5">第二話</a>　←前回</li>
</ul>
<p>つづきです。</p>
<h1><a name="-firebase-" class="anchor" href="#-firebase-"><span class="header-link"></span></a>🔥Firebase🔥で一気にオンラインゲームに！</h1><p><strong>そろそろオンラインゲームっぽくしたくなった</strong>(思いつき)ので、オンラインゲームっぽくしておきましょう。なおPureScriptのFirebaseのバインディングは他の人が書いたものがあったんですが、それが古くて動かなかったので、筆者が自分で書きました。つらい。それではFirebaseに接続！　もちろんコードは基本的にJavaScriptとほとんど同じ！　雰囲気を知ってほしいので、JavaScript版のコードとPureScript版のコードを並べて書いてみます！ JavaScriptならこう！</p>
<pre><code class="haskell:JavaScript">var firebaseApp = firebase.initializeApp({
    apiKey: "AIzaSasdfasdfasfiTNu3gGRNgqRsadlR0",
    authDomain: "zombie-c5857.firebaseapp.com",
    databaseURL: "https://zombie-c5857.firebaseio.com/",
    storageBucket: "zombie-c5857.appspot.com",
    messagingSenderId: "135964071397"
});</code></pre><p>PureScriptならこう！</p>
<pre><code class="haskell:PureScript">firebaseApp ← initializeApp {
    apiKey: "AIzaSasdfasdfasfiTNu3gGRNgqRsadlR0",
    authDomain: "zombie-c5857.firebaseapp.com",
    databaseURL: "https://zombie-c5857.firebaseio.com/",
    storageBucket: "zombie-c5857.appspot.com",
    messagingSenderId: "135964071397"
}</code></pre><p>いやっほおおおおう！😝😝😝　Firebaseきたああああああ！　接続ができたら<code>signInAnonymously</code>で適当に匿名サインイン！:metal:</p>
<pre><code class="js:JavaScript">firebase.auth().signInAnonymously();</code></pre><pre><code class="haskell:PureScript">auth firebase >>= signInAnonymously</code></pre><p>そして<code>onAuthStateChanged</code>を仕掛けておくと、サインインが成功したらコールバックで知らせてくれます。このとき<code>User</code>オブジェクトが手に入るので、適当にユーザIDとかを保存！🏦</p>
<pre><code class="js:JavaScript">firebase.auth().onAuthStateChanged(function(user){
    state.userID = user.uid;
    console.log("signed-in to firebase anonymously. Your id is " + uid user.uid)
})</code></pre><pre><code class="haskell:PureScript">auth firebase >>= onAuthStateChanged \user → do
    modifySTRef stateRef _{ userID = uid user }
    log ("signed-in to firebase anonymously. Your id is " <> uid user)</code></pre><p>自分のキャラの位置が変更されたら<code>set</code>でFirebaseのデータを更新！📝 このときに先ほど保存しておいたユーザIDをキーに使っています。<code>foo</code>っていうIDを持つキャラクターは<code>/users/foo/position</code>っていう位置に保存するっていう感じ。</p>
<pre><code class="js:JavaScript">firebase.database().ref("/users/" + state.userID + "/position").set(state.player.position)</code></pre><pre><code class="haskell:PureScript">database firebase >>= ref ("/users/" <> state.userID <> "/position") >>= set (toForeign state.player.position)</code></pre><p>あとは<code>on(&#39;value&#39;, callback)</code>を仕掛けて待ち構えます！🐢　値が更新されるとコールバックされて新しい値が降ってきますから、それを現在の状態に設定します。</p>
<pre><code class="js:JavaScript">firebase.database().ref("/users").on("value", function(snap){
    state.players = snap.val();
});</code></pre><pre><code class="haskell:PureScript">database firebase >>= ref "/users" >>= onValue \snap → void do
    modifySTRef stateRef _{ players = unsafeFromForeign (val snap) }</code></pre><p>ほら、JavaScriptもPureScriptもコードはあんまり変わらないでしょう？　『純粋関数型プログラミング言語では副作用の扱いが難しい』っていう噂は、純粋関数型をおとしめようとする闇の勢力👽の陰謀です！　さて、あとはFirebaseから送られた情報を元にそれぞれのキャラクターを描画します✏️   あと、詳しくは説明しませんが、キー入力でキャラクターが動きまわるようにしました。ちなみのこの裏で更に座標変換のために線形代数ライブラリを自分で書いたりとなにげに苦労しています（血涙）。それでは、２窓で開いてみると、一方が歩きまわるとちゃんと他方のウィンドウのキャラクターも連携して動き回ることが確認できました！🐾🐾🐾🐾</p>
<p><a href="/img/fa6f0e29-0cbd-f86e-9129-86a6de6eeabd.png"><img src="/img/fa6f0e29-0cbd-f86e-9129-86a6de6eeabd.png"></img></a></p>
<p>おおおおおおおオンラインゲームだ！😆😆😆　かがくのちからってすげー！　たったこれだけでオンラインゲームっぽく同期ができちゃうなんて🔥Firebase🔥最高だよアンタ！　多少の遅延は確認できますが、今回はFPSとか格ゲーじゃないのでそこまでシビアに考えなくていいと思います。</p>
<p>Firebaseのコンソールを開くと、キャラクターが動き回るのに合わせてデータベース内のデータが変化しているのがリアルタイムに確認できます。新たに追加された値は$\color{green}{緑色}$、変更された値は$\color{orange}{黄色}$、削除された値は$\color{red}{赤色}$で表示されます。</p>
<p><a href="/img/b7721386-8854-82f9-4743-9ff688e38242.png"><img src="/img/b7721386-8854-82f9-4743-9ff688e38242.png"></img></a></p>
<p>このときコンソールで直接データを編集することもでき、例えば<code>position</code>の値をいじると対応するキャラクターの位置もリアルタイムで移動したりします。たのしい！😝😝😝</p>
<h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>シーンの切り替え！🔃</h1><p>タイトル画面がないとゲームっぽくないですよね！　そんなわけで、タイトル画面とロード中画面、プレイ画面を切り替えられるようにします。さて、現在どの画面になっているかの状態を表すのに、<strong>代数的データ型</strong>を使いましょう！</p>
<pre><code class="haskell">data Scene = Title | Loading | Playing State</code></pre><p>このデータ型では、</p>
<ul>
<li><code>Title</code>つまりタイトル画面、</li>
<li><code>Loading</code>つまりサインイン待ち中</li>
<li><code>Playing State</code>つまりゲームプレイ中の画面でしかも<code>State</code>型の状態を持っている</li>
</ul>
<p>という表現になっています。<code>Scene</code>型のデータは、<code>Title</code>か、<code>Loading</code>か、<code>Playing</code>のいずれかで、<code>Playing</code>の場合だけ<code>State</code>型のデータを内部に抱えているわけです。</p>
<p>なお、<code>Title</code>とか<strong>名前付けが死ぬほど雑</strong>ですが気にしない気にしない！　もし衝突したらちゃんとコンパイラがエラーで教えてくれますから。あとで気に入らなくなったら、その時に名前を変えればいい話です。名前を変更した場合も、変更すべきポイントをすべてコンパイラが教えてくれます👮</p>
<p>ゲーム開始時はタイトル画面なので、<code>newRef</code>を初期化するときには<code>Title</code>で初期化しましょう。</p>
<pre><code class="haskell">stateRef ← newRef Title</code></pre><p>そして、ゲームループ内では<code>case-of</code>文の条件分岐によって現在の状態にしたがって場合分けをします。</p>
<pre><code class="haskell">gameloop do                              -- この内部がゲームループ
    scene ← readRef stateRef           -- 現在の状態を取得
    case scene of                        -- sceneの値に応じて場合分け
        Title -> do                      -- Titleの場合はここに来る
            pure unit -- do something
        Loading -> do                    -- Loadingの場合はここに来る
            pure unit -- do something
        Playing state -> do              -- Playingの場合はここに来る。しかも変数stateにはState型のデータが入っている
            pure unit -- do something</code></pre><p>場合分けをしたときに、状態が<code>Playing</code>の場合の時だけ<code>State</code>のデータに触ることができるようになっています。なるべく余計な状態は持たないのが楽をするコツです。</p>
<p>そして、タイトル画面のときに<code>z</code>キーを押すと、現在の状態をプレイ中の状態へと変更します。</p>
<pre><code class="haskell">Title -> do                                   -- Titleの場合は
    z <- getKey 90                            -- zキーの状態を取得
    when (z == Just 0) $ void do              -- zキーが押されてる場合の条件分岐
        auth firebase >>= signInAnonymously   -- firebase.auth().signInAnonymously()で匿名サインイン
        writeRef stateRef Loading           -- 現在の状態をLoadingに変える
    drawImage context titleImage 0.0 0.0</code></pre><p>それから、<code>onAuthStateChanged</code>でコールバックされてサインインが成功した時に、<code>Loading</code>状態から<code>Playing</code>状態へと移行します。</p>
<pre><code class="haskell">-- onAuthStateChangedでユーザ認証の状態が変更した時のコールバックを仕掛ける
auth firebase >>= onAuthStateChanged \userMaybe → case userMaybe of      -- caseで場合分け

    -- Nothingの場合はサインアウトした時
    Nothing -> void do
        writeRef stateRef Title    -- タイトル画面に戻る

    Just user -> do
        -- Playing状態へと変える
        writeRef stateRef $ Playing { userID: uid user, rotation: defaultRotation, player, players: empty } 

        -- 後片付け用にonDisconnectを仕掛ける
        database firebase >>= ref ("/users/" <> uid user) >>= onDisconnect >>= remove</code></pre><p>これで、</p>
<ol>
<li>最初はタイトル画面</li>
<li>zキーが押される</li>
<li>サインインのリクエスト＆ローディング画面へ</li>
<li>サインイン成功</li>
<li>プレイ画面へ</li>
</ol>
<p>という状態遷移が実現できました。あとはそれぞれの場合に応じて画面も描画します。</p>
<h1><a name="oauth-" class="anchor" href="#oauth-"><span class="header-link"></span></a>OAuthを利用したサインイン！🔑</h1><p><code>Firebase</code>ではOAuthを利用したサインインの処理も死ぬほど簡単です！ たとえばTwitterでサインインしたかったら、<code>newTwitterAuthProvider</code>(JavaScriptでは<code>new Firebase.TwitterAuthProvider()</code>)で使いたい認証プロバイダを表すオブジェクトを作成し、<code>signInWithPopup</code>を呼びだすだけ！　成功すると<code>onAuthStateChanged</code>がコールバックされます！　</p>
<pre><code class="haskell">provider ← newTwitterAuthProvider
auth firebase >>= signInWithPopup provider authObj onError onSuccess</code></pre><p>うひょおおおおおおおおおお!😁😁😁 コードとしては本当にこのくらい！　ちなみにこれを書いている時点で、匿名、Twitter🐦、GitHub:octocat:、Google🐊の４種類でログインできるようになっています。Firebaseでは普通にメールアドレスとパスワードで認証する方法も提供されているんですが、そんなの入力面倒くさくて誰も使いたがらないでしょうからゲームに実装する気はありません。Facebook👱📘は筆者が使っていないのでパス！</p>
<p><a href="/img/be5f00d7-9185-930d-5f1f-ccf28608ca13.png"><img src="/img/be5f00d7-9185-930d-5f1f-ccf28608ca13.png"></img></a></p>
<p>これで面倒な登録作業なしでゲームを始められます！</p>
<h1><a name="-firebase-" class="anchor" href="#-firebase-"><span class="header-link"></span></a>そういえばデプロイもFirebaseでやってます！☁️</h1><p>Firebaseには静的コンテンツのホスティングの機能もあるので、デプロイにはこれを使ってます。コマンドラインツールのfirebase-toolsを適当にインストールして設定したら、あとは<code>deploy</code>コマンド一発！</p>
<pre><code class="bash">$ firebase deploy</code></pre><p>これだけで<code>public</code>ディレクトリに入ったプロジェクトがデプロイされます！　簡単すぎ！　自分の持っているドメインを接続することもできます。ウェブアプリケーションはもうこいつだけでいいんじゃないかな！😛😛😛</p>
<h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>次のお話🐔</h1><ul>
<li><a href="http://qiita.com/hiruberuto/items/44f118b649367f010cb0">第四話</a></li>
</ul>

            <hr>
            <div class="snsbuttons">

                <!-- Hatena -->
                <div>
                    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
                </div>

                <!-- line -->
                <div>
                    <div class="line-it-button" style="display: none;" data-type="share-a" data-lang="ja" ></div>
                    <script src="//scdn.line-apps.com/n/line_it/thirdparty/loader.min.js" async="async" defer="defer" ></script>
                </div>

                <!--facebook -->
                <div>
                    <div id="fb-root"></div>
                    <script>(function(d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id)) return;
                    js = d.createElement(s); js.id = id;
                    js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8";
                    fjs.parentNode.insertBefore(js, fjs);
                    }(document, 'script', 'facebook-jssdk'));</script>
                    <div class="fb-like" data-href="https://aratama.github.io/kemonogen/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false"></div>
                </div>

                <!-- google+ -->
                <div>
                    <script src="https://apis.google.com/js/platform.js" async defer>
                    {lang: 'ja'}
                    </script>
                    <div class="g-plusone" data-size="medium"></div>
                </div>

            </div>

        </article>
    </div>

    <footer>この文章を書いてる人: <a target="_blank" href="https://twitter.com/cubbit2">Aratama</a></footer>
</body>