<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@cubbit2"><meta name="twitter:creator" content="@cubbit2"><meta name="twitter:title" content="Web Audio APIを使ってブラウザで音楽や音声にエフェクトをかけられるツールを作りました。(2) サウンドフォント - ちょっと小さいのはたしかですが。"><meta name="twitter:description"><meta name="twitter:image"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="icon.png"><link rel="stylesheet" href="/res/reset.css"><link rel="stylesheet" href="/res/style.css"><title>Web Audio APIを使ってブラウザで音楽や音声にエフェクトをかけられるツールを作りました。(2) サウンドフォント - ちょっと小さいのはたしかですが。</title><script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-61162129-3', 'auto');
                ga('send', 'pageview');
            </script></head><body><header><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250"><img src="/res/twitter.png"></a><a target="brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250&amp;t=undefined"><img src="/res/facebook.png"></a><a target="brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250"><img src="/res/google.png"></a><a target="brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250"><img src="/res/hatena.png"></a><a target="brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250&amp;title=undefined"><img src="/res/pocket.png"></a></div><div class="block-centered"><div class="site-title"><a href="/">Admittedly <wbr>something <wbr>small.</a></div><div class="sub-title">ちょっと<wbr>小さいのは<wbr>たしかですが。</div></div></header><div class="content"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/res/article.css"><article id="rendered"><div class="date">2016年1月14日</div><h1 class="article-title"><a href=".">Web Audio APIを使ってブラウザで音楽や音声にエフェクトをかけられるツールを作りました。(2) サウンドフォント</a></h1><p class="tags"><a href="/blog/tag/JavaScript"><span class="tag"><i class="fa fa-tag"></i>JavaScript</span></a><a href="/blog/tag/WebAudioAPI"><span class="tag"><i class="fa fa-tag"></i>WebAudioAPI</span></a><a href="/blog/tag/MIDI"><span class="tag"><i class="fa fa-tag"></i>MIDI</span></a><a href="/blog/tag/purescript"><span class="tag"><i class="fa fa-tag"></i>purescript</span></a><a href="/blog/tag/WebMIDIAPI"><span class="tag"><i class="fa fa-tag"></i>WebMIDIAPI</span></a></p><hr><div><p><a href="72236dfb8476cd490e01.html">前回の記事</a>の続きです。MIDI接続のキーボードなどを接続して、電子キーボードのように楽器の演奏ができるようになりました。今のところ、ピアノやヴァイオリンなどのオーケストラ楽器を中心に、数十種類の音色が用意されています。</p><ul>
<li><a href="http://hiruberuto.bitbucket.org/soundknot/">Soundknot @ Bitbucket</a></li>
<li><a href="https://aratama.github.io/soundknot/">Soundknot @ Github</a></li>
</ul>
<h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>つかいかた</h1><p>MIDIメッセージの入力を扱うMIDIInputノード、MIDIメッセージをオーディオ信号に変換するInstrumentノードが新たに追加されています。つぎのように、MIDIInputノード、Instrumentノード、Compressorノード、Destinationノードを接続してください。</p><p><a href="fac4af43-f2b4-4814-a6a2-8ddc53530d1f.png"><img src="fac4af43-f2b4-4814-a6a2-8ddc53530d1f.png" alt="null"></img></a></p><p>それから、Instrumentノードのドロップダウンリストで任意の音色を選択してください。ドロップボックスで音色を選択すると、音色のデータのダウンロードとデコードが開始され、デコードが完了した音から発音可能になります。Instrumentノード下部のバーが音源の読み込みの状況を表していて、暗いグレーの部分が音が割り当てられていない部分、明るいグレーが読み込み未完了の部分、白がロードとデコードが完了して発音可能になった部分を表しています。白い部分がいっぱいになれば発音可能になり、その白い部分をマウスで押すと、選択された楽器の音が発音されると思います。</p><p>また、MIDIキーボードからの入力にも対応しています。キーボードが接続されると、MidiInputノードにそのキーボードのベンダ名や製品名が表示されると思います。上の画像では筆者が使っている<a href="http://www.korg.co.jp/Product/Controller/microKEY/">Korg microKey USB Keyboard</a>の製品名が表示されています。もし表示されない場合は、MidiInputノードのドロップダウンリストを使ってデバイスを選択してください。キーボードが認識された状態で鍵盤を叩くと、そのMidiInputノードに接続しているInstrumentノードで選択された音がなると思います。</p><p>ひとつのMIDIInputノードに複数のInstrumentノードを接続することもできます。その場合、キーボードを叩くと２種類の音色が同時になります。また、Instrumnetノードで出力される音はもちろん他のどのノードとでも組み合わせることができます。Convolverノードでリバーブを掛けてみたり、Analyserノードで波形を確認してみてもいいでしょう。</p><p>なお、InstrumentノードとDestinationノードの間にコンプレッサが挟まっているのは、複数の音を同時に鳴らすとあっさり音割れしてしまうからです。複数の音が同時になる場合には、Destinationノードの直前につねにCompressorノードが必要になるはずです。現時点の実装では、読み込んだオーディオファイルはすべてメモリ内に溜め込むことにも注意してください。調子にのっていろんな楽器を読み込むと、もりもりメモリを消費していくので気をつけましょう。最悪ページごとクラッシュする可能性があります。</p><h4><a name="webmidilink" class="anchor" href="#webmidilink"><span class="header-link"></span></a>WebMidiLink</h4><p><a href="http://www.g200kg.com/en/docs/webmidilink/">WebMidiLink</a>にも対応してみました。ページをまたがって異なるウェブアプリケーション同士で連携することができます。以下のページに行って、WebMidiLinkのゲストとしてSoundknotを起動してください。</p><ul>
<li><a href="http://www.g200kg.com/en/docs/webmidilink/">http://www.g200kg.com/en/docs/webmidilink/</a></li>
</ul>
<p>それから、次の画像のようにWebMidiLinkノードを接続します。それからWebMidiLinkのホストの方のキーボードを叩くと、ゲストであるSoundknotの方で音が鳴ると思います。ホストの方で「MML Play」ボタンを押すとMMLの再生もできます。SoundknotのほうではMMLには対応していませんが、このように他のアプリケーション同士で連携することでMMLの演奏にも使うことができるわけです。</p><p><a href="fb00d0d8-2f66-05e6-6889-e2a5fe2ff0e5.png"><img src="fb00d0d8-2f66-05e6-6889-e2a5fe2ff0e5.png" alt="null"></img></a></p><hr>
<p>使い方の紹介だけだと知識が増えなくて面白くないでしょうし、この機能に関連して、オーディオプログラミング周りの解説をもう少し加えておきます。</p><h1><a name="midi" class="anchor" href="#midi"><span class="header-link"></span></a>MIDI</h1><p>MIDIは電子機器どうしで演奏情報を交換するための規格です。MIDIはハードウェアの規格も含んでいて、MIDIケーブルというMIDIメッセージを送受信する専用のケーブルもあったのですが、現代ではほとんどUSBに取って代わられているので目にする機会は少なくなりました。USB接続でも各機器が送受信するメッセージは同じで、簡単なバイト列を送り合っているだけです。</p><p>このツールではWeb Midi APIを通じてMIDIメッセージを受け取っています。たとえば、MIDIキーボードの中央の「ド」のキーを押すと、その瞬間に<code>[144, 60, 70]</code>というような単なる数値の配列がイベントを使って渡されます。この３つの数字の先頭の数はメッセージの種類を表していて、<code>144</code>というのはチャンネル<code>0</code>に対する「キーが押された」というメッセージであることを意味しています。次の数<code>60</code>はこの場合は音程で、<code>0</code>から<code>127</code>のいずれかの数が渡されます。最後の数値は「ベロシティ」と呼ばれる音の強さの情報で、鍵盤を勢い良く叩くと大きな値、そっと押し下げると小さな値になり、この値が大きいほど大きな音がなることになります。このようにMIDIがやりとりしているメッセージはとてもシンプルで、MIDIプログラミングもとても簡単です。手順としては次のようになります。</p><ol>
<li><code>navigator.requestMIDIAccess</code>を呼んで<code>MIDIAccess</code>オブジェクトを取得</li>
<li><code>MIDIAccess</code>オブジェクトの<code>inputs</code>プロパティは現在利用可能なMIDI入力を表しているので、そのひとつを選択</li>
<li><code>MIDIInput</code>オブジェクトの<code>onmidimessage</code>プロパティにイベントハンドラを設定する</li>
</ol>
<p>これだけでMIDIメッセージを受け取る事が可能になります。</p><pre><code class="js">navigator.requestMIDIAccess%28%29.then%28function%28midiAccess%29%7B%0A%20%20%20%20midiAccess.inputs.get%280%29.onmidimessage%20%3D%20function%28e%29%7B%0A%20%20%20%20%20%20%20%20console.log%28e.data%29%3B%20%20//%20%u300C%u30C9%u300D%u3092%u62BC%u3059%u3068%20%5B144%2C%2060%2C%2064%5D%u304C%u51FA%u529B%0A%20%20%20%20%7D%3B%0A%7D%29%3B</code></pre><p><a href="https://jsfiddle.net/qkhvaqqu/">https://jsfiddle.net/qkhvaqqu/</a></p><p>ほかに「MIDI」と呼ばれるものには、<code>.smf</code>という拡張子のファイルもあります。これは正式には&quot;Standard MIDI File&quot;といい、MIDIメッセージを元にした演奏情報を記録しておくためのファイルです。SMFは軽量なので、ネットワークが低速な時代にはウェブページにBGMをつけたりしたいときにはよく使われましたし、ゲームのBGMなんかもSMFで配布されることもよくありました。しかし現代のネットワークは高速なのでもはやこの程度の節約などあまり意味はないし、SMFには具体的な音の波形は入っておらず、それを読み込んだソフトウェアがそれぞれの解釈で波形にレンダリングするため再現性がなく、目にする機会はもうほとんどありません。異なるデジタルオーディオワークステーションでのデータ交換で使われる程度です。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>サウンドフォント</h1><p>サウンドフォントは要するに、音色ごと、音程ごとに録音された多数のオーディオファイルをまとめたものです。サウンドフォントのファイルは<code>.sf</code> あるいは <code>.sfz</code>という拡張子がついたもので、このツールではそのうちテキスト形式で扱いやすい<code>.sfz</code>のほうを読み込んで使っています。これらのサウンドフォントのオーディオファイルをMIDIメッセージの内容に合わせてオーディオファイルを選択して再生します。もっとも、このツールではこのツールではネットワーク越しに読み込むという都合上、オーディオファイルをすべてMP3にエンコードしているなど、元のサウンドフォントの内容を多少調整しています。</p><p>このツールではクリエイティブ・コモンズライセンスで公開されている<a href="http://sso.mattiaswestlund.net/">Sonatina Symphonic Orchestra</a>というサウンドフォントを使っています。このサウンドフォントはフリーな割にとてもクオリティが高いので重宝しています。</p></div></article></div><footer><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250"><img src="/res/twitter.png"></a><a target="brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250&amp;t=undefined"><img src="/res/facebook.png"></a><a target="brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250"><img src="/res/google.png"></a><a target="brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250"><img src="/res/hatena.png"></a><a target="brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc8dc4880d5621cfad250&amp;title=undefined"><img src="/res/pocket.png"></a></div><div class="block-centered footer-inner"><p class="copy">&amp;nbsp;</p><p class="author">このブログを書いてる人: 竹内稲穂</p></div><script>
                    const poem = [
                        "なんにもない毎日が、なによりの宝物。",
                        "今日という日を、何度でも繰り返したい。",
                        "世界を追いかけなくても、世界は私のまわりにある。", 
                        "速すぎる雑踏。鼻先をくすぐる春風。", 
                        "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
                        "落ち葉が地面に、触れる音がした。", 
                        "明日は、明日の楽しさが待っている。", 
                        "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
                        "もうここには何もない。だから、次の場所に旅立とう。", 
                        "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
                        "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
                        "思い出はいつだって輝いてる。",
                        "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
                        "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
                        "夜明けを、探しにいこう。", 
                        "空はこんなに青かったんだ。", 
                        "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
                        "休み時間は、長すぎるということはない。", 
                        "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
                        "ちょっと小さいのは確かですが、それは確かにここにあります。", 
                        "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
                        "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
                    ];
                    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
                </script></footer></body></html>