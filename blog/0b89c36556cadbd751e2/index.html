<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@cubbit2"><meta name="twitter:creator" content="@cubbit2"><meta name="twitter:title" content="なるべく早くtimeoutする - ちょっと小さいのはたしかですが。"><meta name="twitter:description"><meta name="twitter:image"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="icon.png"><link rel="stylesheet" href="/res/reset.css"><link rel="stylesheet" href="/res/style.css"><title>なるべく早くtimeoutする - ちょっと小さいのはたしかですが。</title><script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-61162129-3', 'auto');
                ga('send', 'pageview');
            </script></head><body><header><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2"><img src="/res/twitter.png" alt="twitter button"></a><a target="brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2&amp;t=undefined"><img src="/res/facebook.png" alt="facebook button"></a><a target="brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2"><img src="/res/google.png" alt="google plus button"></a><a target="brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2"><img src="/res/hatena.png" alt="hatena bookmark button"></a><a target="brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2&amp;title=undefined"><img src="/res/pocket.png" alt="pocket button"></a></div><div class="block-centered"><div class="site-title"><a href="/">Admittedly <wbr>something <wbr>small.</a></div><div class="sub-title">ちょっと<wbr>小さいのは<wbr>たしかですが。</div></div></header><div class="content"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/res/article.css"><article id="rendered"><div class="date">2015年11月1日</div><h1 class="article-title"><a href=".">なるべく早くtimeoutする</a></h1><p class="tags"><a href="/blog/tag/JavaScript"><span class="tag"><i class="fa fa-tag"></i>JavaScript</span></a></p><hr><div><p>何十秒もかかる重いタスクがあり、それをブラウザ上のJavaScriptでなるべく早く完了させたいとします。でも同期的に一気にやろうとすると、たまには制御返せってブラウザに怒られるし、ページが固まってしまうので困ります。</p><p>たとえば、どうしても<a href="https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%A9%E3%83%83%E3%83%84%E3%81%AE%E5%95%8F%E9%A1%8C">コラッツの問題</a>を自分で確かめたくなっちゃったとします。<code>n</code>に操作を繰り返して1に到達するまでの回数を<code>collatz(n)</code>として、たとえば次のように一気にfor文で調べようとするとページ全体が固まってしまい、ユーザの操作で途中で止めることもできないのでよろしくありません。</p><pre><code class="js">for%28var%20n%20%3D%201%3B%20n%20%3C%3D%2010000000%3B%20n++%29%7B%0A%20%20%20%20console.log%28n%20+%20%22%u306F%22%20+%20collatz%28n%29%20+%20%22%u56DE%u306E%u64CD%u4F5C%u30671%u306B%u5230%u9054%u3057%u307E%u3059%22%29%3B%0A%7D</code></pre><p>ベストなのはWebWorkersを使って別スレッドで処理することですが、Workerスレッド上ではDOMに触れないとかいろいろ制限があります。タスクの内容によってはWorkerの上ではできない、もしくは面倒くさいこともあるでしょう。</p><p>そのようなときには、タスクを分割して<code>setTimeout</code>や<code>setInterval</code>で非同期に処理する方法があります。コラッツの問題ならただの数値計算なのでWeb Workers上でやればいいですが、仮にこの問題がメインスレッド上でないとやりにくいタスクだったとします。具体的には次のような関数<code>sleep</code>を用意すると現代的でちょっとおしゃれかもしれません。</p><pre><code class="js">function%20sleep%28%29%7B%0A%20%20%20%20return%20new%20Promise%28resolve%20%3D%3E%20setTimeout%28resolve%2C%200%29%29%3B%0A%7D</code></pre><p>呼び出す側ではジェネレータ関数の中で</p><pre><code class="js">for%28var%20n%20%3D%201%3B%20n%20%3C%3D%2010000000%3B%20n++%29%7B%0A%20%20%20%20console.log%28n%20+%20%22%u306F%22%20+%20collatz%28n%29%20+%20%22%u56DE%u306E%u64CD%u4F5C%u30671%u306B%u5230%u9054%u3057%u307E%u3059%22%29%3B%0A%20%20%20%20yield%20sleep%28%29%3B%0A%7D</code></pre><p>とループごとに一休みするだけで、ページ全体をブロックすることなく処理を行えます。ただし<code>setTimeout</code>を使うと、<code>setTimeout(f, 0)</code>として<code>delay</code>を0ミリ秒と指定しても最低でも数ミリ秒程度の遅延が生じます。とにかく早く終わらせたいときにはこの遅延が邪魔になるのですが、<code>postMessage</code>でメッセージを投げる → <code>onmessage</code>で即座にイベントを受け取ってタスクをこなす、というトリックを使うことで高速に非同期処理が繰り返せます。</p><p><a href="http://dbaron.org/log/20100309-faster-timeouts">こちら</a>の実装のコードを借りると、次の<code>setZeroTimeout</code>関数はほとんど瞬時に、でもあくまで非同期にコールバックしてくれます。</p><pre><code class="js">//%20Only%20add%20setZeroTimeout%20to%20the%20window%20object%2C%20and%20hide%20everything%0A//%20else%20in%20a%20closure.%0A%28function%20%28%29%20%7B%0A%20%20%20%20var%20timeouts%20%3D%20%5B%5D%3B%0A%20%20%20%20var%20messageName%20%3D%20%22zero-timeout-message%22%3B%0A%0A%20%20%20%20//%20Like%20setTimeout%2C%20but%20only%20takes%20a%20function%20argument.%20%20There%27s%0A%20%20%20%20//%20no%20time%20argument%20%28always%20zero%29%20and%20no%20arguments%20%28you%20have%20to%0A%20%20%20%20//%20use%20a%20closure%29.%0A%20%20%20%20function%20setZeroTimeout%28fn%29%20%7B%0A%20%20%20%20%20%20%20%20timeouts.push%28fn%29%3B%0A%20%20%20%20%20%20%20%20window.postMessage%28messageName%2C%20%22*%22%29%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20handleMessage%28event%29%20%7B%0A%20%20%20%20%20%20%20%20if%20%28event.source%20%3D%3D%20window%20%26%26%20event.data%20%3D%3D%20messageName%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20event.stopPropagation%28%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%28timeouts.length%20%3E%200%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20fn%20%3D%20timeouts.shift%28%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fn%28%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20window.addEventListener%28%22message%22%2C%20handleMessage%2C%20true%29%3B%0A%0A%20%20%20%20//%20Add%20the%20one%20thing%20we%20want%20added%20to%20the%20window%20object.%0A%20%20%20%20window.setZeroTimeout%20%3D%20setZeroTimeout%3B%0A%7D%29%28%29%3B</code></pre><p>この<code>setZetoTimeout</code>を<code>setTimeout</code>の代わりに使うだけでずっと早く処理が終わります。<code>collatz(n)</code>のリアルタイム人気投票をすると<a href="https://jsfiddle.net/3ftgfusg/1/">こんな感じ</a>になります。ただし、<code>setTimeout</code>にはタブが裏に回るなどでページが非表示になると自動的に頻度を落として無用な処理を減らしてくれるという機能もあります。<code>setZeroTimeout</code>のほうはページが非表示だろうがお構いなしに全力疾走してしまいますが、それが迷惑な場面もあるでしょうから注意が必要です。使い道があるようなないような……。</p><h1><a id="%E5%8F%82%E8%80%83" class="anchor" href="#%E5%8F%82%E8%80%83"><span class="header-link"></span></a>参考</h1><ul>
<li><a href="http://dbaron.org/log/20100309-faster-timeouts">http://dbaron.org/log/20100309-faster-timeouts</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/API/Window/setTimeout">https://developer.mozilla.org/ja/docs/Web/API/Window/setTimeout</a></li>
</ul>
</div></article></div><footer><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2"><img src="/res/twitter.png" alt="twitter button"></a><a target="brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2&amp;t=undefined"><img src="/res/facebook.png" alt="facebook button"></a><a target="brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2"><img src="/res/google.png" alt="google plus button"></a><a target="brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2"><img src="/res/hatena.png" alt="hatena bookmark button"></a><a target="brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2F0b89c36556cadbd751e2&amp;title=undefined"><img src="/res/pocket.png" alt="pocket button"></a></div><div class="block-centered footer-inner"><p class="copy">&amp;nbsp;</p><p class="author">このブログを書いてる人: 竹内稲穂</p></div><script>
                    const poem = [
                        "なんにもない毎日が、なによりの宝物。",
                        "今日という日を、何度でも繰り返したい。",
                        "世界を追いかけなくても、世界は私のまわりにある。", 
                        "速すぎる雑踏。鼻先をくすぐる春風。", 
                        "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
                        "落ち葉が地面に、触れる音がした。", 
                        "明日は、明日の楽しさが待っている。", 
                        "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
                        "もうここには何もない。だから、次の場所に旅立とう。", 
                        "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
                        "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
                        "思い出はいつだって輝いてる。",
                        "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
                        "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
                        "夜明けを、探しにいこう。", 
                        "空はこんなに青かったんだ。", 
                        "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
                        "休み時間は、長すぎるということはない。", 
                        "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
                        "ちょっと小さいのは確かですが、それは確かにここにあります。", 
                        "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
                        "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
                    ];
                    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
                </script></footer></body></html>