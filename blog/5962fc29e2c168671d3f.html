<!DOCTYPE html>
<meta charset="UTF-8">

<!-- Twitter card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@cubbit2">
<meta name="twitter:creator" content="@cubbit2">
<meta name="twitter:title" content="モナドのまほう　第９話『サウンドエフェクトの作業をしてコーディングで荒んだ心を癒やします』 - ちょっと小さいのはたしかですが。">
<meta name="twitter:description" content="わたしのブログです。面白いかどうかは、わかりませんが。">
<meta name="twitter:image" content="https://aratama.github.io/img/dadb4c03-2d12-85f4-1d08-09ea1a1f8b84.png">

<link rel="icon" type="image/png" href="icon.png">
<link rel="stylesheet" href="/res/reset.css">
<link rel="stylesheet" href="/res/style.css">

<title>モナドのまほう　第９話『サウンドエフェクトの作業をしてコーディングで荒んだ心を癒やします』 - ちょっと小さいのはたしかですが。</title>

<header>
    <div class="block-centered">
        <div class="site-title"><a href="/">ちょっと小さいのはたしかですが。</a></div>
        <div class="sub-title">わたしのブログです。面白いかどうかは、わかりませんが。</div>
    </div>
</header>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<!--
<link rel="stylesheet" href="/lib/highlight/styles/default.css">
<script src="/lib/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
-->

<!--
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$']]}
});
</script>
-->


<link rel="stylesheet" href="/res/article.css">


    <div class="content">

        <article id="rendered">
            <div class="date">2016年12月6日</div>
            <h1 class="article-title">
                <!-- <i class="fa fa-coffee" aria-hidden="true"></i> -->
                <a href="5962fc29e2c168671d3f.html">モナドのまほう　第９話『サウンドエフェクトの作業をしてコーディングで荒んだ心を癒やします』<a>
            </h1>        
            <p class="tags"><a href="JavaScript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>JavaScript</span></a>
<a href="WebGL.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>WebGL</span></a>
<a href="ゲーム制作.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>ゲーム制作</span></a>
<a href="purescript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>purescript</span></a>
<a href="REAPER.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>REAPER</span></a></p>
            <hr>
            <!-- {
  "id": "5962fc29e2c168671d3f",
  "created_at": "2016-12-06T02:02:20+09:00",
  "tags": [
    {
      "name": "JavaScript",
      "versions": []
    },
    {
      "name": "WebGL",
      "versions": []
    },
    {
      "name": "ゲーム制作",
      "versions": []
    },
    {
      "name": "purescript",
      "versions": []
    },
    {
      "name": "REAPER",
      "versions": []
    }
  ],
  "title": "モナドのまほう　第９話『サウンドエフェクトの作業をしてコーディングで荒んだ心を癒やします』"
} -->
<ul>
<li><a href="/blog/5321d8cebce7b87851f6.html">第一話　画像が表示できました</a>　←初回</li>
<li><a href="/blog/c1017d61978afbce6cc5.html">第八話　たまにはデモします</a>　←前回</li>
</ul>
<p>ゲームを作る日記です。オーディオ作業は難しい理屈とか要らなくてフィーリングだけでできるので心が癒されます。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>環境音</h1><p>音がないとどうも寂しいということで、森の中っぽい環境音をつけることにしました。さすがにサウンドエフェクトまで自分で録音してくるというわけにはいかなかったので、フリーの素材を探します。<a href="/blog/http://www.freesound.org.html">freesound</a>がいろいろな素材があっていい感じです。このなかからCreateive Commons Attribution 3.0 Unportedなライセンスのものを借りることにします。</p><ul>
<li><a href="/blog/https://www.freesound.org/people/HerbertBoland/sounds/28239/.html">https://www.freesound.org/people/HerbertBoland/sounds/28239/</a></li>
</ul>
<p>説明によると初夏のイギリスのカントリーハウスで採ったものだとか。おしゃれですね。ただ、これはあくまで「素材」であって、実際にゲーム内で使うためにはいろいろと加工が必要です。この素材の場合は、一部に虫の羽音が入っていたり、トンという何かの物音（鳥追い用の銃声？）が入っていたので、これを除去します。</p><p><a href="/blog/http://www.reaper.fm/.html">Reaper</a>でファイルを再生しながらノイズを探します。「トン」というノイズがあったところの波形をみると、確かにちょっとだけ波形に山があるのがわかりました。</p><p><a href="/img/dadb4c03-2d12-85f4-1d08-09ea1a1f8b84.png"><img src="/img/dadb4c03-2d12-85f4-1d08-09ea1a1f8b84.png"></img></a></p><p>それではオペを始めます。よろしくお願いします。Item -&gt; Split item at cursorsで該当部分に切れ目を切れます。それから患部を切除します。</p><p><a href="/img/b78b7652-810c-ad8d-90b4-a92b1f7ec6fd.png"><img src="/img/b78b7652-810c-ad8d-90b4-a92b1f7ec6fd.png"></img></a></p><p>あとはアイテムを少しずらして縫合するだけ。重なった部分はReaperが自動的にフェードイン・フェードアウトをかけて滑らかにしてくれるので簡単です。音楽だとこうはいきませんが、こういう環境音ならいくらでも誤魔化しが利きます。あとは試しに聴いてみて違和感がなければ、Item -&gt; Glue itemsでアイテムをマージします。</p><p>これで終わりでもいいんですが、サウンドエフェクトがループする瞬間に無音になってしまうので、なるべく継ぎ目を目立たなくさせるために全体をコピペで複製して２分くらいの長さにしました。それから全体の最初と最後の部分にフェードイン・フェードアウトを効かせます。</p><p><a href="/img/b088e7fb-7456-b2cc-ec65-8e34c98c2692.png"><img src="/img/b088e7fb-7456-b2cc-ec65-8e34c98c2692.png"></img></a></p><p>本当はコンプレッサをかけて音量調節なんかもしたほうがいいですが、とりあえずはこれで問題なさそうなのでこれで。あとはMP3形式で書き出してフィニッシュ。ちょっとファイルサイズが大きいですが、そのあたりはまたいつか調整しようと思います。</p><p>babylonjsに音声再生の機能があるので、プログラミングの方も簡単です。<code>BABYLON.Sound</code>クラスのコンストラクタをラップした<code>loadSound</code>関数を用意したので、音声を読み込むにはこれを呼ぶだけです。<code>autoplay</code>オプションを指定しているので、読み込みが完了したら自動的に再生が始まります。また<code>loop</code>オプションを指定しているので、再生が終わったら自動的にループします。しかもこの関数は非同期処理モナド<code>Aff</code>のモナディックな作用になっていて、音声の読み込みが完了するまでゲームの開始を待機する処理が簡単に書けます。</p><pre><code class="haskell">forestSound <- loadSound "forest.mp3" "forest.mp3" scene defaultCreateSoundOptions { autoplay = true, loop = true }</code></pre><p>実際にこの環境音を聴いてみたい人は<a href="/blog/https://aratama.github.io/cubbit/.html">前回出したデモ</a>をどうぞ。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>一人称視点</h1><p>一人称視点も実装しました。Pointer Lock APIを使って、FPSのゲームみたいにマウスで直接向きを変えながら操作できます。一人称視点は直感的ではあるんですが、キャラクターの動きを見せられないのがちょっと残念です。マインクラフトみたいに割りきって完全にストーリーを省く場合は、キャラクター性がなくてもいいとは思うのですが……。</p><p>First Person Shooterのようなゲームでの操作に慣れている人が多いので、一人称視点ではWASDで移動、マウスムーブで向きの変更という操作にせざるを得ません。その場合画面上に配置したボタンをマウスで押せなくなるので、いろんなモードの切替がちょっと不便です。その一方で、三人称視点では向きを変更しなくてもある程度自分の周囲の状況がわかるので、向きの変更がそれほど頻繁には必要なくなります。そのためマウスポインタをロックしなくても大丈夫で、マウスポインタを画面上のボタンを操作するために使えます。</p><p>また、ブロック建築ではとくに三人称のほうが便利です。一人称だと、足元のブロックの奥の面が見えにくいので、水平にブロックを継ぎ足して伸ばしていくのがやりにくいのです。操作性にもいろいろとこだわりたいです。</p><h1><a name="ui-" class="anchor" href="#ui-"><span class="header-link"></span></a>UIライブラリ</h1><p>グラフィックは見た目はあまり変わっていませんが、プログラムの中身のほうは大幅なリファクタリングが行われています。一番大きい変化は、UIがすべて<a href="/blog/https://github.com/slamdata/purescript-halogen.html">purescript-halogen</a>というライブラリ上へと移行したことです。今まではいきあたりばったりにFFIを呼んでDOMを動かしていたんですが、今後ユーザインターフェイスが複雑化するのを見込んですべて書き換えました。</p><p>ゲーム向けという特殊な利用に耐えられるのか心配でしたが、なんとかなりそうです。UIの状態が変更されるとDOMの再描画が走ってしまうので、ゲーム向けでは毎フレームDOMの再描画が起きてしまいかねないので効率に問題がありそうな気がしていたんですが、UIの状態とリアルタイムで変化する状態を分離することでうまくいきそうです。UIの状態は基本的にクリックなどのユーザ入力のときだけ変更されるようになっています。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>輪郭線</h1><p>キャラクターに輪郭線を表示してみました。<a href="/blog/http://www.4gamer.net/games/216/G021678/20140703095/index_2.html.html">背面法</a>という古典的な方法を使っています。少しキャラクターの印象が引き締まるのはいいのですが、このゲームではいまのところカメラが引いている場面が多いので、それほど印象が変わるわけではないように思いました。輪郭線なしでも見栄えは問題ない気がします。たしかにアニメっぽくはあるのですが、アニメの再現を目指しているわけでもないですし。どんどんモデルが重くなっていく……。</p><p><a href="/img/6a5684c8-ef66-417f-394f-aff999ac128e.png"><img src="/img/6a5684c8-ef66-417f-394f-aff999ac128e.png"></img></a></p><p>あと、Blenderでモデルを作ってbabylonjsに書き出したい人は、以下のTipsは必ず読んでおいたほうがいいと思います。知らないとモデルの表示が崩れてハマります。要するに、ひとつの頂点は最大４つのボーンからの影響しか受けられないのですが、それを超える頂点があったとしても警告が出るだけで書き出しが成功したように見えます。でもボーンを動かすとウェイトが足りないのでぐにゃっとモデルが崩れます。もうこれ警告じゃなくてエラーでいいと思うんですけどね。</p><p><a href="/blog/https://doc.babylonjs.com/exporters/Blender_Tips.html">https://doc.babylonjs.com/exporters/Blender_Tips</a></p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>今後の(ずさんな)計画</h1><ul>
<li>まずはコードをリファクタリングしまくる（めんどくさい）</li>
<li>自動化されたテストが欲しいです(ぶっちゃけ最優先で必要だけと、いい方法が思いつかない)</li>
<li>自由に走ったり飛んだりできすぎるので、キャラクターのコリジョンをどうにかしたいです。現時点では物理エンジンを使わずに自前で実装する構え</li>
<li>現状のキャラクターモーションは不自然すぎるので調整したい。あと「立ち」と「走り」だけじゃ不自然なので、「ジャンプ」と「着地」くらいは欲しいです　(いつでも着手できるので優先順位低)</li>
<li>babylonのバグで上手く動かないので、水面マテリアルの移植  (優先順位低)</li>
<li>現状では無限に動きまわれる＆無限に掘れる＆無限に積めるなので『ゲーム』にはなっていないです。せめて周囲の探索→素材集め→建築の流れができるようにしたいです。それができれば最低限『ゲーム』の体裁がつきます</li>
<li>それができたらFirebaseに統合してマルチプレイヤー化。ひとりだとゲーム内でたくさんの課題を与えないと飽きやすいですが、他のプレイヤーの気配があると飽きにくいので</li>
<li>シングルプレイモードとマルチプレイモードを用意したい（願望）</li>
</ul>
<h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>次のお話</h1><ul>
<li><a href="/blog/b1731c7b802cfc835b42.html">第10話 ゲッダン☆と謎の儀式《バッド・ノウハウ》</a></li>
</ul>

            
<hr style="margin-top: 200px;">

<div class="snsbuttons">

    <!-- Twitter -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-related="cubbit2">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <!-- Hatena -->
    <div>
        <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>

    <!-- line -->
    <div>
        <div class="line-it-button" style="display: none;" data-type="share-a" data-lang="ja" ></div>
        <script src="//scdn.line-apps.com/n/line_it/thirdparty/loader.min.js" async="async" defer="defer" ></script>
    </div>

    <!--facebook -->
    <div>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8";
        fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
        <div class="fb-like" data-href="https://aratama.github.io/blog/${metadata.id}.md" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false"></div>
    </div>

    <!-- google+ -->
    <div>
        <script src="https://apis.google.com/js/platform.js" async defer>
        {lang: 'ja'}
        </script>
        <div class="g-plusone" data-size="medium"></div>
    </div>

</div>
        </article>
    </div>

<footer>
    <div class="block-centered footer-inner">
        <p class="copy">&nbsp;</p>
        <p class="author">このブログを書いてる人:&nbsp;&nbsp; 兎沢<p>
    </div>

    <script>
        const poem = [
            "なんにもない毎日が、なによりの宝物。",
            "今日という日を、何度でも繰り返したい。",
            "世界を追いかけなくても、世界は私のまわりにある。", 
            "速すぎる雑踏。鼻先をくすぐる春風。", 
            "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
            "落ち葉が地面に、触れる音がした。", 
            "明日は、明日の楽しさが待っている。", 
            "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
            "もうここには何もない。つまり、はじまりの時が来た。", 
            "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
            "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
            "思い出はいつだって輝いてる。",
            "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
            "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
            "夜明けを、探しにいこう。", 
            "空はこんなに青かったんだ。", 
            "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
            "休み時間は、長すぎるということはない。", 
            "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
            "ちょっと小さいのは確かですが、それは確かにここにあります。", 
            "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
            "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
        ];
    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
    </script>
</footer>

