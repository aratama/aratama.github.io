<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@cubbit2"><meta name="twitter:creator" content="@cubbit2"><meta name="twitter:title" content="モナドのまほう　第８話『たまにはデモします』 - ちょっと小さいのはたしかですが。"><meta name="twitter:description"><meta name="twitter:image"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="icon.png"><link rel="stylesheet" href="/res/reset.css"><link rel="stylesheet" href="/res/style.css"><title>モナドのまほう　第８話『たまにはデモします』 - ちょっと小さいのはたしかですが。</title><script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-61162129-3', 'auto');
                ga('send', 'pageview');
            </script></head><body><header><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5"><img src="/res/twitter.png"></a><a target="_brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5&amp;t=undefined"><img src="/res/facebook.png"></a><a target="_brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5"><img src="/res/google.png"></a><a target="_brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5"><img src="/res/hatena.png"></a><a target="_brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5&amp;title=undefined&quot;"><img src="/res/pocket.png"></a></div><div class="block-centered"><div class="site-title"><a href="/">Admittedly <wbr>something <wbr>small.</a></div><div class="sub-title">ちょっと<wbr>小さいのは<wbr>たしかですが。</div></div></header><div class="content"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/res/article.css"><article id="rendered"><div class="date">2016年12月1日</div><h1 class="article-title"><a href=".">モナドのまほう　第８話『たまにはデモします』</a></h1><p class="tags"><a href="/blog/tag/JavaScript"><span class="tag"><i class="fa fa-tag"></i>JavaScript</span></a><a href="/blog/tag/WebGL"><span class="tag"><i class="fa fa-tag"></i>WebGL</span></a><a href="/blog/tag/Blender"><span class="tag"><i class="fa fa-tag"></i>Blender</span></a><a href="/blog/tag/Babylon.js"><span class="tag"><i class="fa fa-tag"></i>Babylon.js</span></a><a href="/blog/tag/purescript"><span class="tag"><i class="fa fa-tag"></i>purescript</span></a></p><hr><div><ul>
<li><a href="5321d8cebce7b87851f6.html">第一話　画像が表示できました</a>　←初回</li>
<li><a href="2d186fd463afa50075b5.html">第七話　オープンワールドという泥沼</a>　←前回</li>
</ul>
<p>babylonjsとかPureScriptとかを使って好きなように楽しくゲームを作る日記です。思いついたことを取り留めもなく書いています。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>デモ</h1><p>キャラクターが歩き回れるようになったので、簡単なデモを用意しました。こちらのページを開くと、ちょっと不安になるくらいのロード時間のあとでプレイが始まります。</p><ul>
<li><a href="https://aratama.github.io/cubbit/">https://aratama.github.io/cubbit/</a></li>
</ul>
<p>WASDで歩き回れます。左上の&quot;add&quot;ボタンを押すとマウスでブロックを積めるようになり、&quot;Remove&quot;ボタンを押すとブロックを削除できるようになります。Chromeで開発しているのでChromeが最適だと思いますが、私の環境ではFirefoxやEdgeでも問題なく動いています。手元のマシンでしかテストしていませんし、WebGLを使っていて環境依存は多少あると思いますが、たぶん動くと思います。ウェブをプラットフォームにすると簡単にデモを見せられるので便利ですね。怪しいネイティブなアプリケーションなんて誰も使いたくないと思いますし。</p><p>ちなみに、Electronでももちろん動きます。気持ちの問題ですが、Electronで動かすとなんか<strong>大作ゲームな予感</strong>がしてちょっとテンションがあがります。ブラウザで遊ぶと、同じゲームなのになんか所詮はお手軽なミニゲーム、っていう思い込みが働いてしまいます。刷り込みってこわいです。</p><p>これでボクセル世界の構築とその中を歩きまわることができるようになったので、サンドボックスゲームの枠組みとしては概ね形になってきたと思います。十分にリファクタリングをしてから、元のプロジェクトと統合しようと思います。というかグラフィック部分は完全に書きなおされているので、引き継ぐのはfirebaseの部分くらい……。ほとんど書き直しじゃないですか……。ただ、コリジョンの実装の方法については未だに決めかねています。上のデモでは当たり判定がガバガバなので段差の上にぴょんと乗り上げてしまうのですが、いずれはこれも直さなくてはなりません。自前で衝突判定を実装するか、それとも<a href="http://www.cannonjs.org/">cannon.js</a>のような本格的な物理エンジンを導入するか、悩みどころです。cannonを使ったほうがいろいろ自由が増すのですが、一方で本格的な物理エンジンを使うといわゆる「havok神の怒り」が発動しやすくて挙動をコントロールするのが難しくなります。パフォーマンスの問題に突き当たる可能性もあります。一方で、自前の実装は大変ですが、パフォーマンスチューニングをしやすいですし、予想外の挙動を抑えられるのでその意味では実装は楽です。どうしよう……。</p><p>あと、世界が完全に停止しているのが不自然ですね。多少は画面に動きを与えないと臨場感が出ません。Minecraftの影Modみたいに、草木を風で揺らしたり、水面を動かしたいです。あと動物を歩かせたいです。なんか記事に書くのはめんどうくさくてコードを出してませんので、必要ならgithubも覗いてみてください。純粋関数型プログラミングの学習の参考になればと思って、ソースコードはぜんぶ公開しています(でもオープンソースではないです)。純粋関数型プログラミング言語でもゲームは作れるんですよ！</p><h1><a name="-vs-" class="anchor" href="#-vs-"><span class="header-link"></span></a>一人称視点vs三人称視点</h1><p>一人称視点を基本にすると没入感は増すのですが、ジャンプなどのアクションがやりにくいですし、プレイヤーのキャラクターを見せることが難しくなります。マインクラフトのように一切ストーリーのないゲームなら完全に一人称でもいいのですが、そういうゲームは新規のプレイヤーにとって遊びにくくなりますし、多少はプレイヤーにストーリーや課題を与えたほうが遊びやすい気がします。そのため、基本的には三人称視点で、必要に応じて一人称視点に切り替えられるようにしようと思ってます。ただし、三人称視点の扱いもかなり難しいところが多いです。</p><p><a href="2dd58e89-8744-f688-909d-c4f34f3844e1.png"><img src="2dd58e89-8744-f688-909d-c4f34f3844e1.png"></img></a></p><p>三人称で地下に潜ると、カメラが壁を突き抜けるため断面図状態になります。これはこれで<a href="http://terraria.org/">テラリア</a>みたいでプレイはしやすそうなのですが、ちょっと開放感が溢れすぎてしまって地下の閉塞感が台無しです。一人称視点ならこういうことはないのですが、このあたりどうするかも考えなくてはいけません。よくある手としては壁を突き抜けないようにカメラを近づける方法がありますが、これをやるとカメラが大きくブレて見づらいですし、狭い空間ではカメラの距離が近くなりすぎて余計に狭苦しいです。課題は多いです。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>シェーダ</h1><p>水面はまだゼリー状の質感です。babylonで提供されている水シェーダがうまく動かないのですが、まあコピーして改造すれば動くとは思うのであとで実装しようと思います。babylonの水シェーダがちゃんと動けば<a href="http://www.babylonjs-playground.com/#1SLLOJ#17">こんな感じ</a>になるそうです。そういえば草もランダムに生やしました。雑すぎて、弁当に入っている「バラン」っぽいです。</p><p><a href="609eb586-89e5-6e70-a139-f96fe211f009.png"><img src="609eb586-89e5-6e70-a139-f96fe211f009.png"></img></a></p><p>なんかもっと絵に馴染む感じにしたいです。どうしよう……。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>また遠足テスト</h1><p>世界は16<em>16</em>16ブロックの『チャンク』に分割されて管理されるのですが、キャラクターの周囲のチャンクは自動的にロードされ、同時に遠くにあるチャンクは自動的にアンロードされていきます。このため巨大な世界を歩き回ってもメモリが足りなくなったりしないというわけです。それで、<strong>キーボードのwキーの上に乾電池を置いて数分放置する</strong>という自動化されたテストを実施したところ、水平方向のZ座標で1万メートルを超える位置に来ても落ちたりせずにちゃんとプレイできるのが確認できました。ただ、数千メートルを超える位置に来るとシャドウがおかしくなる問題が見つかりました。原因は調査中ですが、Babylonjsのバグを疑っています(babylonのバグを踏みすぎて疑心暗鬼)。</p><p>垂直方向についてもテストするためにひたすらブロックを縦に積み、これで上空1000メートルです。1000回クリックしました（手動）。</p><p><a href="ff03ba50-059b-b323-7307-f5249be6b877.png"><img src="ff03ba50-059b-b323-7307-f5249be6b877.png"></img></a></p><p>地上は遠すぎてアンロードされてしまうので見えませんが、見えたとしてもフォグがかかってほとんと判別できないと思います。それでもすぐにアンロードされて見えなくなってしまうのでは超高層建築の楽しみが減ってしまうので、この辺りもどうするか検討中です。</p><p>高さに制限がないと、ライティングでも問題が増えます。一部のチャンクを読み込んだだけでは、そこに日光が当たるのかどうか判別できないからです。どうしよう……。っていうかもうすぐ大きなリファクタリングをするつもりなので、そろそろテストも自動化しないと……ゲームの自動テストなんてどうすりゃいいんだ……。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>もういちど規模の概算をする</h1><p>元のプロジェクトとの統合の前に、Firebaseでデータを扱いきれるかどうか、もう一度検討してみます。ただのチャットアプリとかならともかく、ゲームが世界が無制限のオープンワールドなゲームだけに、下手をすると開発時のテストプレイだけで一瞬でfirebaseの無料枠を使いきってしまう可能性もあるので、ここはちゃんと最初からケチっておいたほうがいい気がします。</p><p>チャンクを読み込む際は配列で読み込むと効率がいいのでしょうが、firebaseは配列を直接扱えません。一つの方法としては<code>JSON.stringify</code>して文字列として転送してしまう方法が考えられますが、この表現にすると今度はブロックをひとつ置くたびにチャンク全体を送らなければならなくなります。1チャンクが16<em>16</em>16=4096ブロックで、カンマ区切りの数値を文字列にしてケチって表現すると、UTF8だとして1チャンクあたり10キロバイトほど。一方で、オブジェクトとしてチャンクを表現するともっと効率が悪そうです。つまり、</p><pre><code class="undefined">%5B0%2C%200%2C%201%2C%20...%2C%200%2C%201%5D</code></pre><p>というような配列を</p><pre><code class="undefined">%7B%0A%20%20%20%20%220%22%3A%200%2C%0A%20%20%20%20%221%22%3A%200%2C%0A%20%20%20%20%222%22%3A%201%2C%0A%20%20%20%20...%0A%20%20%20%20%224094%22%3A%200%2C%0A%20%20%20%20%224095%22%3A%201%0A%7D</code></pre><p>こんな感じのオブジェクトとして送受信することになります。ゲーム開始時にはチャンクをまるごと受信しなければならないので、これはかなりの大きさになってしまいます。ただし、一旦ゲームが開始すると、ブロックを置いた時にはその部分だけを書き換えればいいため、チャンク全体をひとつの文字列に押し込むよりはずっと効率がよくなるはずです。将来を見越して、ここはオブジェクトとして表現することにします。</p><p>なお、地形データすべてを先にfirebaseに格納してしまえばクライアント側で生成する必要がなくなるのですが、ちょっとデータ量が多くなりすぎます。10チャンク距離までロードするとすると、<code>21 * 21 * 21 = 9261</code>チャンクを読み込むことになるので、<code>10kbyte * 9261</code>で92メガバイトほど。これで少し歩き回れば、簡単に数百メガバイトを消費するでしょう。ローカルならどうということはない数字ですが、起動しただけでこの量ではfirebaseの無料枠1GBを一瞬で使い切りそうです。しかもストアが厳しいのはもちろん、ダウンロード枠が10GBしかないので、下手をするとテストプレイを繰り返すだけでこっちも一瞬で使い切ると思われます。保存するのは一度でもブロックを置いたり削除したチャンクだけにする必要があると思います。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>ライティング</h1><p>そういえば、頂点色を利用してブロックに簡易的な陰影をつけています。これには「アンビエントオクルージョン」なんてたいそうな名前がついていますが、要するに物体の凹んだところは光が当たる量が少ないので暗くなる、というだけの話です。解説の記事もありました。</p><ul>
<li><a href="https://0fps.net/2013/07/03/ambient-occlusion-for-minecraft-like-worlds/">Ambient occlusion for Minecraft-like worlds</a></li>
</ul>
<p>これがないとかなり見た目がのっぺりとして凹凸が見分けにくくなり、見た目だけでなくプレイアビリティにも影響してきます。物理的に厳密に計算するのは大変ですが、シミュレーションではないのでなんとなくそれっぽく見えさえすればいいのです。上の記事のやり方とは少し違いますが、筆者も同様のものを実装しています。</p><p>それと、NotchさんによるMinecraftのライティングシステムの簡単な解説も見つけたのでメモです。まあこれだけじゃ情報が少なすぎてあんまり参考にはならない気がしますが……。</p><ul>
<li><a href="http://notch.tumblr.com/post/434902871/per-request-this-is-how-the-new-lighting-will">Per request: This is how the new lighting will work</a></li>
</ul>
<h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>次のお話</h1><ul>
<li><a href="5962fc29e2c168671d3f.html">第九話 サウンドエフェクトの作業をしてコーディングで荒んだ心を癒やします</a></li>
</ul>
</div></article></div><footer><div class="sns"><a target="_blank" href="https://twitter.com/intent/tweet?text=undefined%20https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5"><img src="/res/twitter.png"></a><a target="_brank" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5&amp;t=undefined"><img src="/res/facebook.png"></a><a target="_brank" href="https://plus.google.com/share?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5"><img src="/res/google.png"></a><a target="_brank" href="http://b.hatena.ne.jp/entry/https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5"><img src="/res/hatena.png"></a><a target="_brank" href="http://getpocket.com/edit?url=https%3A%2F%2Faratama.github.io%2Fblog%2Fc1017d61978afbce6cc5&amp;title=undefined&quot;"><img src="/res/pocket.png"></a></div><div class="block-centered footer-inner"><p class="copy">&amp;nbsp;</p><p class="author">このブログを書いてる人: 竹内稲穂</p></div><script>
                    const poem = [
                        "なんにもない毎日が、なによりの宝物。",
                        "今日という日を、何度でも繰り返したい。",
                        "世界を追いかけなくても、世界は私のまわりにある。", 
                        "速すぎる雑踏。鼻先をくすぐる春風。", 
                        "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
                        "落ち葉が地面に、触れる音がした。", 
                        "明日は、明日の楽しさが待っている。", 
                        "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
                        "もうここには何もない。だから、次の場所に旅立とう。", 
                        "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
                        "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
                        "思い出はいつだって輝いてる。",
                        "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
                        "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
                        "夜明けを、探しにいこう。", 
                        "空はこんなに青かったんだ。", 
                        "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
                        "休み時間は、長すぎるということはない。", 
                        "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
                        "ちょっと小さいのは確かですが、それは確かにここにあります。", 
                        "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
                        "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
                    ];
                    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
                </script></footer></body></html>