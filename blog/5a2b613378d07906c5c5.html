<!DOCTYPE html>
<meta charset="UTF-8">

<!-- Twitter card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@cubbit2">
<meta name="twitter:creator" content="@cubbit2">
<meta name="twitter:title" content="モナドのまほう　第２話『ゲームループとキー入力ができました』 - ちょっと小さいのはたしかですが。">
<meta name="twitter:description" content="Admittedly something small.">
<meta name="twitter:image" content="https://aratama.github.io/img/da2f674d-b893-2934-6acd-96be3ececa69.png">

<link rel="icon" type="image/png" href="icon.png">
<link rel="stylesheet" href="/res/reset.css">
<link rel="stylesheet" href="/res/style.css">

<title>モナドのまほう　第２話『ゲームループとキー入力ができました』 - ちょっと小さいのはたしかですが。</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61162129-3', 'auto');
  ga('send', 'pageview');

</script>

<header>
    <div class="block-centered">
        <div class="site-title"><a href="/">ちょっと小さいのはたしかですが。</a></div>
        <div class="sub-title">Admittedly something small.</div>
    </div>
</header>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<!--
<link rel="stylesheet" href="/lib/highlight/styles/default.css">
<script src="/lib/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
-->

<!--
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$']]}
});
</script>
-->


<link rel="stylesheet" href="/res/article.css">


    <div class="content">

        <article id="rendered">
            <div class="date">2016年10月29日</div>
            <h1 class="article-title">
                <!-- <i class="fa fa-coffee" aria-hidden="true"></i> -->
                <a href="5a2b613378d07906c5c5.html">モナドのまほう　第２話『ゲームループとキー入力ができました』<a>
            </h1>        
            <p class="tags"><a href="JavaScript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>JavaScript</span></a>
<a href="purescript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>purescript</span></a>
<a href="オンラインゲーム.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>オンラインゲーム</span></a>
<a href="Firebase.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>Firebase</span></a>
<a href="関数型プログラミング.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>関数型プログラミング</span></a></p>
            <hr>
            <ul>
<li><a href="/blog/5321d8cebce7b87851f6.html">第一話　画像が表示できました</a>　←前回</li>
</ul>
<p>つづきです。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>座標変換！👀</h1><p>前回は画像の読み込みと複数回の描画ができました。ここで<strong>急にクォータービューっぽく表示してみたくなった</strong>（思いつき）ので、そうしてみます！　<code>translate</code>とか<code>scale</code>とか<code>rotate</code>とかそういう座標変換の関数をそういう感じに呼びます！　アフィン変換について知らない人はゲームプログラミングの書籍なんかを読んでお勉強してみましょう！</p><pre><code class="haskell">translate { translateX: 1280.0 * 0.5 , translateY: 720.0 * 0.5 } context
scale { scaleX: 1.0, scaleY: 0.6 } context
rotate (45.0 / 180.0 * pi) context</code></pre><p>これらの関数について、詳しくは<a href="https://developer.mozilla.org/ja/docs/Web/HTML/Canvas">Canvas API</a>をどうぞ。</p><h1><a name="-code-save-code-code-restore-code-" class="anchor" href="#-code-save-code-code-restore-code-"><span class="header-link"></span></a><code>save</code>/<code>restore</code>！👮</h1><p>そして忘れてはいけないのが、コンテキストの<code>save</code>と<code>restore</code>。これを忘れるとゲームループが回るたびに座標変換が蓄積していってわけのわからないことになります。まあまだゲームループも実装していませんけど。もちろんPureScriptからでも問題なく<code>save</code>と<code>restore</code>を呼ぶことができます。</p><pre><code class="haskell">save context
pure unit   -- do something
restore context</code></pre><p>でも、これじゃうっかり<code>restore</code>を書き忘れるかも……。そんなときは<code>withContext</code>っていう関数が用意されているので、これを使えば自動的に<code>save</code>と<code>restore</code>をしてくれるので楽ちん！</p><pre><code class="haskell">withContext context do
    pure unit -- do something</code></pre><p><code>save</code>のあとにこの一段インデントされた部分が実行され、それが終わると勝手に<code>restore</code>してくれます。それでは表示してみましょう。</p><p><a href="/img/da2f674d-b893-2934-6acd-96be3ececa69.png"><img src="/img/da2f674d-b893-2934-6acd-96be3ececa69.png"></img></a></p><p>きっったあああああああああ！😈😈😈　クォータービュー🔸だ！　でも英語ではIsometric projectionっていうそうですよ！</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>ゲームループとキー入力！👈</h1><p>静止画を表示しただけではゲームにはなりません。アニメーション、すなわち画面を時間にそって変化させることが必要ですが、そのためにはいわゆる<strong>ゲームループ</strong>が必要です。今はとくにゲームライブラリを使っていないので、ゲームループも自作する必要がありますが、この部分はJavaScriptで書きました（血涙）。イベントハンドラを仕掛けたりと多少DOMをいじらなくてはならないのですが、PureScriptの生DOMライブラリは死ぬほど面倒くさくて、はっきり言って使わないほうがよっぽどマシです。でもあんまりガチなUIフレームワークを使うほどではないので、代わりにJavaScriptでゲームループ関連のコードを書いて、それを<strong>外部関数インターフェイス</strong>を使ってPureScriptから呼び出すことにします。</p><p>JavaScript側は適当にこんな感じに。PureScriptから呼び出されるJavaScriptコードはCommonJSモジュールとして書きます。呼び出されたらすぐに内容を実行するのではなく、いったん引数のない関数オブジェクトを返しているのが特徴です。PureScript側からもう一度その関数オブジェクトを呼び出すことで本体が実行されます。</p><pre><code class="js">exports.gameloop = function(callback){
    return function(){
        function next(){
            callback();
            count += 1;
            window.requestAnimationFrame(next);
        }
        var count = 0;
        window.addEventListener("keydown", function(e){
            if( ! keyTable.hasOwnProperty(e.keyCode)){
                keyTable[e.keyCode] = count;
            }
        });
        window.addEventListener("keyup", function(e){
            delete keyTable[e.keyCode];
        });
        next();
    };
};</code></pre><p>PureScript側はこんな感じ。</p><pre><code class="haskell">foreign import gameloop :: forall eff . Eff (gameloop :: GameLoop, dom :: DOM | eff) Unit → Eff (dom :: DOM | eff) Unit</code></pre><p>この関数<code>gameloop</code>はこんな感じで呼び出します。</p><pre><code class="haskell">gameloop do
    withContext context do
        translate { translateX: 1280.0 * 0.5 , translateY: 720.0 * 0.5 } context
        scale { scaleX: 1.0, scaleY: pitch / 90.0 } context
        rotate (45.0 / 180.0 * pi) context
        translate { translateX: 36.0 * -2.0 , translateY: 36.0 * -2.0 } context

        for (0 .. 9) \y → do
            for (0 .. 9) \x → do
                drawImage context grass (36.0 * toNumber x) (36.0 * toNumber y)
        pure unit</code></pre><p>こうすると、<code>gameloop</code>からひとつインデントされた部分が<code>requestAnimationFrame</code>のタイミングで繰り返し実行されます。これで何度も再描画はされているのですが、何も表示が変わっていないのでアニメーションしているように見えません……😭😭😭</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>変更可能な領域！👽</h1><p>さて、PureScriptは<strong>純粋関数型プログラミング言語</strong>であり、<strong>すべての式が純粋</strong>です。噂には聞いたことがあるかもしれませんが、次のようにして変数を直接書き換えて状態を変更することができません。</p><pre><code class="haskell">let counter = 0
gameloop do
    counter = counter + 1    -- こういうことはできない！</code></pre><p>なんてこった……😦　状態を変えられないとか、純粋関数型な言語じゃゲームにならないじゃないか……もう駄目だ……お終いだ……😰　いや！　まだだ！　まだ<strong><code>Ref</code></strong>がある！ 使い方は簡単で、<code>newRef</code>で変更可能な状態を作り、<code>readRef</code>で状態の読み取り、<code>writeRef</code>や<code>modifyRef</code>で状態の書き換えができます。</p><pre><code class="haskell">ref ← newRef 0                -- 可変な領域を作成！　初期値は0！
gameloop do
    count ← readRef ref       -- 領域から値の読み取り！
    writeRef ref (count + 1)  -- 領域への値の書き込み</code></pre><p>これで、ゲームループが回るたびにカウンターがひとつずつ増えていきます。状態を読み取る前に<code>readRef</code>を呼んで領域から現在の状態を取り出さなくてはならないのがちょっと面倒ですが、三匹の豚精神で乗り切ります。逆にいえば、DOMや外部のライブラリが持つ状態を除けば、<strong>アプリケーション自身の状態といえるものはこの<code>ref</code>の状態だけ</strong>であり、それ以外にはまったく状態を持たないのが保証されるので、アプリケーションの状態の管理がとても楽です。なんかゲームの状態がおかしくなったなあと思ったらこの<code>ref</code>の中だけ確認すればいいのです。</p><p>それでは、さっき<code>gameloop</code>関数と一緒に定義した<code>getKey</code>関数で、キーの状態を取得し、現在の状態に反映させます。それからその状態を使って画面を再描画します。試しに、変更されている状態を、座標変換の回転量に使いましょうか。実行させてみるとこうなります。</p><p><a href="/img/ee9618f4-39b3-8157-59c2-535157fd4780.png"><img src="/img/ee9618f4-39b3-8157-59c2-535157fd4780.png"></img></a></p><p>あああああああ！　キー操作でくるくる回っているのに、静止画だから伝わらない！　詳しくは実際に動かしてみてください。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>画像の読み込み(二回目)！📷</h1><p>現状の方法だと、読み込む画像が増えるたびにネストがどんどん増えていってしまいます。</p><pre><code class="haskell">main = do
    withImage "grass.png" \grass → do
        withImage "foo.png" \foo → do
            withImage "bar.png" \bar → do
                pure unit</code></pre><p>これはキモいので、<strong>非同期処理モナド</strong>という謎の技術を使ってこれを平坦に書けるようにします(なお、PureScriptの非同期処理モナドについては、<a href="/blog/98598af2b0e9a6206ef3.html">こちら</a>で筆者も紹介しています)。これを使って<code>loadImage</code>という関数を定義すると、こんなふうに書けるようになります。</p><pre><code class="haskell">main = launchAff do
    grass ← loadImage "grass.png"
    foo ← loadImage "foo.png"
    bar ← loadImage "bar.png"
    pure unit</code></pre><p>よし！🌞　これでネストが増えていかない！🌵　え？　なんでこういうふうに書けるのかって？　そういう難しいことをあんまり気にしちゃだめです！</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>全体像!🐔</h1><p>今日のところはここまでにしておいてやる！👮　キャンバスを取得するところとかもちょっとリファクタリングして、こんなかんじです(再現)。</p><pre><code class="haskell">main = launchAff do
    grass ← loadImage "grass.png"
    canvas ← getCanvas "canvas"
    liftEff $ runST do
        context ← getContext2D canvas
        stateRef ← newSTRef (0 :: Int)

        gameloop do
            state ← readSTRef stateRef
            let zeroOrOne key = maybe 0 (const 1) <$> getKey key
            rx ← (-) <$> zeroOrOne 68 <*> zeroOrOne 65
            writeSTRef stateRef (state + rx)

            clearRect context { x: 0.0, y: 0.0, w: 1280.0, h: 720.0 }
            withContext context do
                translate { translateX: 1280.0 * 0.5 , translateY: 720.0 * 0.5 } context
                scale { scaleX: 1.0, scaleY: 0.6 } context
                rotate (45.0 / 180.0 * pi) context
                for_ (0 .. (chunkSize - 1)) \y → do
                    for_ (0 .. (chunkSize - 1)) \x → do
                        drawImage context grass (36.0 * toNumber x) (36.0 * toNumber y)</code></pre><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>次のお話🐔</h1><ul>
<li><a href="/blog/5d3f61339e84d2715f71.html">第三話　オンラインゲームになりました</a></li>
</ul>
<hr>

            
<hr style="margin-top: 60px;">

<div class="snsbuttons">

    <!-- Twitter -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-related="cubbit2">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <!-- Hatena -->
    <div>
        <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>

    <!-- line -->
    <div>
        <div class="line-it-button" style="display: none;" data-type="share-a" data-lang="ja" ></div>
        <script src="//scdn.line-apps.com/n/line_it/thirdparty/loader.min.js" async="async" defer="defer" ></script>
    </div>

    <!--facebook -->
    <div>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8";
        fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
        <div class="fb-like" data-href="https://aratama.github.io/blog/${metadata.id}.md" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false"></div>
    </div>

    <!-- google+ -->
    <div>
        <script src="https://apis.google.com/js/platform.js" async defer>
        {lang: 'ja'}
        </script>
        <div class="g-plusone" data-size="medium"></div>
    </div>

</div>
        </article>
    </div>

<footer>
    <div class="block-centered footer-inner">
        <p class="copy">&nbsp;</p>
        <p class="author">このブログを書いてる人:&nbsp;&nbsp; 羽佐田<p>
    </div>

    <script>
        const poem = [
            "なんにもない毎日が、なによりの宝物。",
            "今日という日を、何度でも繰り返したい。",
            "世界を追いかけなくても、世界は私のまわりにある。", 
            "速すぎる雑踏。鼻先をくすぐる春風。", 
            "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
            "落ち葉が地面に、触れる音がした。", 
            "明日は、明日の楽しさが待っている。", 
            "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
            "もうここには何もない。だから、次の場所に旅立とう。", 
            "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
            "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
            "思い出はいつだって輝いてる。",
            "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
            "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
            "夜明けを、探しにいこう。", 
            "空はこんなに青かったんだ。", 
            "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
            "休み時間は、長すぎるということはない。", 
            "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
            "ちょっと小さいのは確かですが、それは確かにここにあります。", 
            "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
            "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
        ];
    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
    </script>
</footer>

