<title>モナドのまほう　第11話『タイトル画面があるとゲームっぽい』 - ちょっと小さいのはたしかですが。</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<link rel="stylesheet" href="/res/highlight/styles/default.css">
<script src="/res/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$']]}
});
</script>

<link rel="stylesheet" href="../reset.css">
<link rel="stylesheet" href="../style.css">

<body>
    <header>
        <div>
            <div class="site-title"><a href="index.html">ちょっと小さいのはたしかですが。</a></div>
            <div class="sub-title">プログラミングとかのブログ</div>
        </div>
    </header>
    <div class="content">

        <article id="rendered">
            <div class="date">2016年12月18日</div>
            <h1 class="article-title">モナドのまほう　第11話『タイトル画面があるとゲームっぽい』</h1>        
            <p class="tags"><a href="Blender.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>Blender</span></a>
<a href="Babylon.js.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>Babylon.js</span></a>
<a href="ゲーム開発.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>ゲーム開発</span></a>
<a href="purescript.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>purescript</span></a></p>
            <hr>
            <!-- {
  "id": "d057a411bfd10a0b7924",
  "created_at": "2016-12-17T21:05:16+09:00",
  "tags": [
    {
      "name": "Blender",
      "versions": []
    },
    {
      "name": "Babylon.js",
      "versions": []
    },
    {
      "name": "ゲーム開発",
      "versions": []
    },
    {
      "name": "purescript",
      "versions": []
    }
  ],
  "title": "モナドのまほう　第11話『タイトル画面があるとゲームっぽい』"
} -->
<p><a href="http://qiita.com/hiruberuto/items/5321d8cebce7b87851f6">第一話</a> / <a href="http://qiita.com/hiruberuto/items/b1731c7b802cfc835b42">前回</a></p>
<p>ゲームを作る日記です。『<a href="http://magicofstella.com/">ステラのまほう</a>』を見てたら、なんだかやる気が湧いてきました。</p>
<h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>タイトル画面とかオプション画面とかを作りました</h1><p><a href="/img/ea7d82ad-27d5-c99c-a386-9d44ce449d58.png"><img src="/img/ea7d82ad-27d5-c99c-a386-9d44ce449d58.png"></img></a></p>
<p>タイトル画面をつけました。これがあると、ぐっとゲームっぽい雰囲気になる気がします。今回のタイトル画面のポイントは、背景にちゃんとゲーム内の世界の３Dグラフィックスを使っているところです。タイトル画面が一枚絵だとなんだかタイトル画面とプレイ画面の雰囲気に落差が出来てしまいますが、最初から３Dグラフィックを使うことでユーザをゲームの世界に自然にグッと引きずりこみやすくなると思います。<a href="http://store.steampowered.com/app/108600/?l=japanese">Project Zomboid</a>というゲームがあるんですが、<a href="http://steam.degica.com/news2/project-zomboid">タイトル画面はリアル系の一枚絵</a>なのに、ゲーム本編はドット絵調の表現なのでどこか肩の力が抜ける感じがあって、そういうのを避けたかったわけです。</p>
<p>タイトルロゴもタイトルすらもまだ仮置きですが、画面が寂しくならないように何かアルファベットを書いとけ的な安直な発想でいろいろ描いています。雰囲気大切です。雰囲気が出てくると、ゲームに対するイメージも湧いてきます。先にイメージを固めてからグラフィック作業を一気に仕上げるより、とにかく仮置きして雰囲気を確かめながらゆっくりイメージを作っていくのが好きです。イメージが湧いたから作るというより、作ったからイメージが湧いてきた、というのは結構あります。</p>
<p>オプション設定もできるようにしました。</p>
<p><a href="/img/0cad15ee-0462-0b0f-410e-c96c7352f273.png"><img src="/img/0cad15ee-0462-0b0f-410e-c96c7352f273.png"></img></a></p>
<p>グラフィック面では影の表現がかなり重いんですが、これでオプションで簡単に影をオフにできるようになりました。ユーザの環境はバラバラなので、調節できるようにしておくのは必要だと思います。ちなみにここでの設定はLocal Storageに保存されるので、次回起動したときにも自動的に適用されます。</p>
<h1><a name="purescript-halogen" class="anchor" href="#purescript-halogen"><span class="header-link"></span></a>purescript-halogen</h1><p>UIにはpurescrip-halogenというライブラリを使っているのですが、今回はゲームということでちょっと用途が特殊で、使い方にひと工夫必要でした。最初うまく行かないかと思って、自分でゲーム用のUIライブラリを作りかけたりしていて作業はかなり回り道をしてました。purescript-halogenはたぶんそろそろ大きいバージョンアップがあります。APIが整理されてかなり扱いやすくなるので、いずれぜひ紹介したいライブラリです。</p>
<h1><a name="babylonjs-" class="anchor" href="#babylonjs-"><span class="header-link"></span></a>Babylonjsのバージョンアップ</h1><p>Babylonjsが先日2.5にバージョンアップしたんですが、嫌なエラーが出ました。JavaScript側では何もエラーが起きなくて、WebGLの側からエラーが飛んでくるやつです。</p>
<pre><code class="undefined">[.Offscreen-For-WebGL-091CF920]GL ERROR :GL_INVALID_OPERATION : glDrawElements: attempt to access out of range vertices in attribute 2</code></pre><p>うへえ。幸い、エラーの引き金になっているのがキャラクターの描画の部分であることはすぐにわかりました。地形の描画に比べてキャラクターのロードは一瞬遅れるのですが、エラーが起き始めているのはキャラクターが表示されてからだったからです。でも不思議なことにキャラクターの表示には問題ないようです。いろいろ試してみましたが、バッグや髪の毛といった小物のメッシュを削除して本体部だけをエクスポートするとエラーは起きません。これである程度エラーの引き金になっている部分は絞れました。結局のところ、輪郭を出すために使っている裏返したメッシュをすべて削除してエクスポートするとエラーが収まりました。うーんこの</p>
<p>それに、2.5になったら明らかにパフォーマンスが低下しました。FPSにして3分の2くらいになってしまいます。仕方ないのでbabylonjsのバージョンアップはひとまずあきらめました。なんかもうほんとにbabylonjsのバグとの戦いです。でもWebGL関係のライブラリはみんな死ぬほど複雑で環境依存も大きくテストもしにくいので、どのライブラリもバグはとても多いです。babylonjsが特別バグが多いわけではないでしょうし、他のライブラリに移行したところでそのライブラリでもバグに苦しめられるのは目に見えています。なんとか力づくでねじ伏せるしかありません。とにかくファイル交換の部分だけでも安定してほしいです。</p>
<h1><a name="browserify-" class="anchor" href="#browserify-"><span class="header-link"></span></a>browserifyしたくない</h1><p>purescript-halogenを使うときに<code>require</code>を解決しなくてはならないのでbrowserifyを使っているのですが、ファイルをガンガン結合するとデバッガで追うときに重くなるのであまり好きではないです。デバッガがどんどん重くなるのもありますし、Chromeにはデバッガでソースファイルを指定してステップオーバーできる<a href="http://qiita.com/k12u/items/3d667c1cf5287625024c">Blackboxing</a>という機能がありますが、browerifyをかますとBlackboxingができなくなるというのもあります。</p>
<p>依存関係をコンパイル時に解決したいというのはわかりますが、このアプリケーションでは複雑な依存関係のあるものはPureScriptの部分だけで、あとはfirebase, babylonjs, virtual-domというそれぞれ独立したいくつかのライブラリがあるだけです。今回の場合はbrowerifyに解決してほしい複雑な依存関係はありません。またグローバルな空間に名前をばらまきたくないというのはわかるんですが、<code>FIREBASE</code>, <code>VirtualDOM</code>, <code>BABYLON</code>という名前がグローバルで衝突するとは思えません。ソースファイルを結合するよりは、HTMLの<code>script</code>タグを自動で構成してくれたらとか思うんですが。</p>
<h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>次のお話</h1><p>そういえば、firebaseの話はしばらく出てこない気がしたので記事のタイトルを少し変えました。タイトル長過ぎましたし。また変えるかもしれません。</p>
<ul>
<li><a href="http://qiita.com/hiruberuto/items/cdf2a7bb66fdcbf1a78c">第12話　RPGアツマールに私も集まーる</a></li>
</ul>

            <hr>
            <div class="snsbuttons">

                <!-- Hatena -->
                <div>
                    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
                </div>

                <!-- line -->
                <div>
                    <div class="line-it-button" style="display: none;" data-type="share-a" data-lang="ja" ></div>
                    <script src="//scdn.line-apps.com/n/line_it/thirdparty/loader.min.js" async="async" defer="defer" ></script>
                </div>

                <!--facebook -->
                <div>
                    <div id="fb-root"></div>
                    <script>(function(d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id)) return;
                    js = d.createElement(s); js.id = id;
                    js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8";
                    fjs.parentNode.insertBefore(js, fjs);
                    }(document, 'script', 'facebook-jssdk'));</script>
                    <div class="fb-like" data-href="https://aratama.github.io/blog/d057a411bfd10a0b7924.md" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false"></div>
                </div>

                <!-- google+ -->
                <div>
                    <script src="https://apis.google.com/js/platform.js" async defer>
                    {lang: 'ja'}
                    </script>
                    <div class="g-plusone" data-size="medium"></div>
                </div>

            </div>

        </article>
    </div>

    <footer>この文章を書いてる人: <a target="_blank" href="https://twitter.com/cubbit2">Aratama</a></footer>
</body>