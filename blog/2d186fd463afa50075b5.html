<!DOCTYPE html>
<meta charset="UTF-8">

<!-- Twitter card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@cubbit2">
<meta name="twitter:creator" content="@cubbit2">
<meta name="twitter:title" content="モナドのまほう　第７話『オープンワールドという泥沼』 - ちょっと小さいのはたしかですが。">
<meta name="twitter:description" content="Admittedly something small.">
<meta name="twitter:image" content="https://aratama.github.io/img/a8429ecc-fe8b-7a2b-dd71-ab7f169b79fa.png">

<link rel="icon" type="image/png" href="icon.png">
<link rel="stylesheet" href="/res/reset.css">
<link rel="stylesheet" href="/res/style.css">

<title>モナドのまほう　第７話『オープンワールドという泥沼』 - ちょっと小さいのはたしかですが。</title>

<header>
    <div class="block-centered">
        <div class="site-title"><a href="/">ちょっと小さいのはたしかですが。</a></div>
        <div class="sub-title">Admittedly something small.</div>
    </div>
</header>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<!--
<link rel="stylesheet" href="/lib/highlight/styles/default.css">
<script src="/lib/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
-->

<!--
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$']]}
});
</script>
-->


<link rel="stylesheet" href="/res/article.css">


    <div class="content">

        <article id="rendered">
            <div class="date">2016年11月27日</div>
            <h1 class="article-title">
                <!-- <i class="fa fa-coffee" aria-hidden="true"></i> -->
                <a href="2d186fd463afa50075b5.html">モナドのまほう　第７話『オープンワールドという泥沼』<a>
            </h1>        
            <p class="tags"><a href="GLSL.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>GLSL</span></a>
<a href="minecraft.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>minecraft</span></a>
<a href="Babylon.js.html"><span class="tag"><i class="fa fa-tag" aria-hidden="true"></i>Babylon.js</span></a></p>
            <hr>
            <!-- {
  "id": "2d186fd463afa50075b5",
  "created_at": "2016-11-27T13:26:57+09:00",
  "tags": [
    {
      "name": "GLSL",
      "versions": []
    },
    {
      "name": "minecraft",
      "versions": []
    },
    {
      "name": "Babylon.js",
      "versions": []
    }
  ],
  "title": "モナドのまほう　第７話『オープンワールドという泥沼』"
} -->
<ul>
<li><a href="/blog/5321d8cebce7b87851f6.html">第一話　画像が表示できました</a>　←初回</li>
<li><a href="/blog/247c6c0034b6383c5436.html">第六話　Blenderで涼風青葉ちゃんごっこの巻</a>　←前回</li>
</ul>
<p>粛々とゲームを作る日記です。しかも純粋関数型プログラミング言語で。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>マインクラフトより狭いけど高い</h1><p>コーディングでは最適化作業が続いていてつらかったですが、パフォーマンスの問題はなんとか解決の目処が立ってきました。地中に隠れた部分の頂点を根本的に削減することで、ポリゴン数は以前の数十分の一にまで減っています。いろいろと小汚い最適化を繰り返したので細かいバグの修正や調整はまだ必要ですが、これでマインクラフトと同じくらいの描画範囲が確保できそうです。</p><p>マインクラフトの世界は水平方向に三千万ブロック四方の大きさがあるらしいのですが、本作はいまのところ26万ブロック四方程度の広さしかありません。これはパフォーマンス上の理由で三次元の座標をひとつの数値型に押し込んで表現しているからです。倍精度浮動小数点数型の仮数部52ビットのうち、X軸に18ビット、Z軸に18ビット、Y軸に16ビットを割り当てています。地形を生成するときに座標の計算が大量に行われるのですが、ここで座標を表すオブジェクトを作成してしまうとガーベージコレクタが動きまくってカックカクになるので、無理やりプリミティブな数値だけで表現しているのです。</p><p>マインクラフトの場合は高さ方向の空間の大きさが固定になっているらしく、0から255までの範囲にしかブロックが置けないようになっているそうです。それに対して、本作では上下方向にもそのような制限がなく、ひたすら天空を目指してブロックを積み上げたり、ひたすら地下を目指して掘り下げたりすることができます。垂直方向に16ビットの精度が確保されているので、水平面をゼロとして32767ブロックまで積み上げることが理論上可能です。またマイナス方向にも32768ブロックまで掘り下げることが可能になっています。1ブロック=1メートルとすればエベレストでもすっぽり収まる高さで、これ以上の高さになるとお前は軌道エレベータでも建造するつもりかという話なので十分な広さは確保できていると思います。</p><p>そんなわけで、ちゃんと果てしなくブロックを積めるか試してみましたが、200ブロックを超えた高さでも問題ありませんでした。</p><p><a href="/img/a8429ecc-fe8b-7a2b-dd71-ab7f169b79fa.png"><img src="/img/a8429ecc-fe8b-7a2b-dd71-ab7f169b79fa.png"></img></a></p><p>手作業でクリックして積んだので、これ以上は面倒くさくて止めました。</p><p><a href="/img/b9fe917a-203f-35a5-d82e-766a597b365e.png"><img src="/img/b9fe917a-203f-35a5-d82e-766a597b365e.png"></img></a></p><p>カリン塔みたいです。</p><p><a href="/img/e96b7b9f-ed88-c945-04d9-b9015224dbe4.png"><img src="/img/e96b7b9f-ed88-c945-04d9-b9015224dbe4.png"></img></a></p><p>ただし、高いところまで行くと見晴らしは良くなるものの、その高さで見渡せるだけの広さの地形を表示できるわけではないので、あんまり高く登っても見晴らしに関しては意味が無いです。作ってみてわかったのですが、マインクラフトの256ブロックという高さ制限はそのへん合理的なので、本作の仕様も考えなおすかもしれません。あんまり垂直方向に自由度が高くても、地下の大半は表示されることもなく隠れているし、上空はほとんどがブロックのない空隙なので無駄が多いのです。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>セルシェーディング</h1><p>前回ゲーム内に表示した時は顔に影が落ちてとても見苦しかったのですが、アニメみたいに塗り分けるセルシェーディングへ切り替えたら多少は見れる画になってきました。<a href="http://www.html5gamedevs.com/topic/4691-shader-cel-shading/">こちら</a>で紹介されていたシェーダをそのまま使っているだけですが、前回の初代プレイステーションみたいな画よりはずっとマシだと思います。</p><p><a href="/img/d936f499-b662-99fb-1a0e-588a5b2d3cbf.png"><img src="/img/d936f499-b662-99fb-1a0e-588a5b2d3cbf.png"></img></a></p><p>ただ、この単純なシェーダでは影の部分で肌の色がくすんでいるのがちょっとつらいです。現実なら人間の皮膚はある程度光を通すので、その際に血液の色の影響で若干赤みがかかって鮮やかな光が出てくるのです。直接光が当たっている部分は直接の反射光が強すぎてその赤みがわかりにくいのですが、影の部分はわりと赤みがかってみえるので、これがキャラクターの肌の生き生きとした質感に影響します。二次元のイラストレーションでも影はちょっと彩度を上げて塗ったりするのです。それがこのシェーダでは再現できていないので、またいろいろ調整が要ると思います。</p><p>あと、キャラクターに輪郭を表示するともっとアニメっぽくなりますね。ただし、なめらかな輪郭線を表示するにはポリゴンがかなり細かくなければならず、下手に荒いポリゴン数で輪郭を出そうとするとゴミが現れて小汚くなります。まだ試していませんが、うまくいくかどうか……。</p><p>本作のグラフィックデザインを考えるに、そもそもこの手のブロック積み上げる形式のグラフィックではあまりにディフォルメが効きすぎていて、どうあってもシリアスな雰囲気にはならないということに気付きました。最初はSFでゾンビでシリアスなホラー路線を考えていたのですが、もうファンタジーでメルヘンでキュート路線で行こうと思います。</p><p>っていうか、なんかセルシェーディングのためにマテリアルを切り替えたら、今度はアニメーションが効かなくなる問題が……。<del>たぶんbabylonjsのバグだと思うんですけど</del>いやこれバグじゃないですわ。シェーダ書き換えたんだから当たり前です。シェーダをアニメーションに対応させなくては。</p><h1><a name="bgm-" class="anchor" href="#bgm-"><span class="header-link"></span></a>BGMを作ろうとして早々に挫折</h1><p>babylonjsのオーディオ再生機能を試そうと思ったのですが、その前に自分でBGMも作りたくなってしまって、今度はそっちの作業に手を付けることに。でもこれ……今回の一連の作業のなかで<strong>ぶっちぎりに一番難しい</strong>ですわ。私は多少の楽器の心得はあるのですが、作曲まではやったことないので、いざ作ろうと思ってもどこから手を付けてよいやら……。</p><p>それに、作曲の作業をするならフルサイズのキーボードが必要ですね。アレンジや耳コピするときなんかには２オクターブしかない小さなキーボードを使っているのですが、これでは片手づつでしか演奏できないのでぜんぜん曲のイメージが掴めないのです。しかもこれまで使っていたStudio Oneがバージョン3からSFZ形式のサウンドフォントが使えなくなるという制限が増えてしまって、ソフトウェアの方も馴染むツールがないでつらいです。Studio One2を使うしか……。もうフリー素材に頼るべきかどうか……ひとまず音楽は後回しです。</p><h1><a name="-" class="anchor" href="#-"><span class="header-link"></span></a>次のお話</h1><ul>
<li><a href="/blog/c1017d61978afbce6cc5.html">第八話　たまにはデモします</a></li>
</ul>

            
<hr style="margin-top: 200px;">

<div class="snsbuttons">

    <!-- Twitter -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-related="cubbit2">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <!-- Hatena -->
    <div>
        <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>

    <!-- line -->
    <div>
        <div class="line-it-button" style="display: none;" data-type="share-a" data-lang="ja" ></div>
        <script src="//scdn.line-apps.com/n/line_it/thirdparty/loader.min.js" async="async" defer="defer" ></script>
    </div>

    <!--facebook -->
    <div>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8";
        fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
        <div class="fb-like" data-href="https://aratama.github.io/blog/${metadata.id}.md" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false"></div>
    </div>

    <!-- google+ -->
    <div>
        <script src="https://apis.google.com/js/platform.js" async defer>
        {lang: 'ja'}
        </script>
        <div class="g-plusone" data-size="medium"></div>
    </div>

</div>
        </article>
    </div>

<footer>
    <div class="block-centered footer-inner">
        <p class="copy">&nbsp;</p>
        <p class="author">このブログを書いてる人:&nbsp;&nbsp; 羽佐田<p>
    </div>

    <script>
        const poem = [
            "なんにもない毎日が、なによりの宝物。",
            "今日という日を、何度でも繰り返したい。",
            "世界を追いかけなくても、世界は私のまわりにある。", 
            "速すぎる雑踏。鼻先をくすぐる春風。", 
            "明日撮る写真を飾る場所を、アルバムに空けておこう。", 
            "落ち葉が地面に、触れる音がした。", 
            "明日は、明日の楽しさが待っている。", 
            "風が泣いている。この想いを紡ぐ言葉を持たないから。", 
            "もうここには何もない。つまり、はじまりの時が来た。", 
            "もう此処にはこないだろう。そう言って私は過去に背を向けた。", 
            "散りゆくからこそ、美しい。私は桜の花びらをかかとで踏みしめた。", 
            "思い出はいつだって輝いてる。",
            "正直ばかりじゃつまらない。たまには楽しい嘘をつこう。", 
            "ゆっくり歩けば歩くほど、時間がゆっくり過ぎてゆく。",
            "夜明けを、探しにいこう。", 
            "空はこんなに青かったんだ。", 
            "地球は青かった。それはこの空を見上げたことのある全員が知っている。", 
            "休み時間は、長すぎるということはない。", 
            "缶コーヒーを飲むときだけは、それ以外のすべてを忘れることにしてる。", 
            "ちょっと小さいのは確かですが、それは確かにここにあります。", 
            "ちょっと小さいのは確かですが、広すぎる家というのも寂しいでしょう？", 
            "ひつじが一匹、ひつじが二匹。五十匹までは、数えたことがある。"
        ];
    document.querySelector(".copy").textContent = poem[Math.floor(poem.length * Math.random())];
    </script>
</footer>

